@using SelfOrganizer.Core.Models
@using SelfOrganizer.Core.Interfaces
@using SelfOrganizer.App.Services
@inject IRepository<UserPreferences> PreferencesRepository
@inject IContextService ContextService
@inject IBalanceDimensionService BalanceDimensionService
@inject IThemeService ThemeService
@inject ISampleDataService SampleDataService

@if (IsVisible)
{
    <div class="onboarding-overlay">
        <div class="onboarding-wizard @(_animationClass)">
            @* Progress Indicator *@
            <div class="progress-indicator mb-4">
                @for (int i = 0; i < TotalSteps; i++)
                {
                    var stepIndex = i;
                    <div class="progress-step @(stepIndex == _currentStep ? "active" : "") @(stepIndex < _currentStep ? "completed" : "")"
                         @onclick="() => GoToStep(stepIndex)">
                        <div class="step-dot">
                            @if (stepIndex < _currentStep)
                            {
                                <span class="oi oi-check"></span>
                            }
                            else
                            {
                                @(stepIndex + 1)
                            }
                        </div>
                        <span class="step-label">@GetStepLabel(stepIndex)</span>
                    </div>
                }
            </div>

            @* Step Content *@
            <div class="step-content @(_stepAnimationClass)">
                @switch (_currentStep)
                {
                    case 0:
                        @* Theme Selection - First step for immediate visual comfort *@
                        <div class="text-center animate-fade-in">
                            <div class="step-icon mb-3">
                                <span class="oi oi-sun" style="font-size: 3rem; color: #f59e0b;"></span>
                            </div>
                            <h2 class="mb-3">Choose Your Theme</h2>
                            <p class="text-muted mb-4">
                                Let's start by making you comfortable. Select your preferred appearance.
                            </p>
                            <div class="theme-selection">
                                <button class="theme-option @(_selectedTheme == ThemeLight ? "selected" : "")"
                                        @onclick="SelectLightTheme">
                                    <div class="theme-preview light-preview">
                                        <div class="preview-sidebar"></div>
                                        <div class="preview-content">
                                            <div class="preview-card"></div>
                                            <div class="preview-card"></div>
                                        </div>
                                    </div>
                                    <span class="theme-name">Light Mode</span>
                                    @if (_selectedTheme == ThemeLight)
                                    {
                                        <span class="oi oi-check theme-check"></span>
                                    }
                                </button>
                                <button class="theme-option @(_selectedTheme == ThemeDark ? "selected" : "")"
                                        @onclick="SelectDarkTheme">
                                    <div class="theme-preview dark-preview">
                                        <div class="preview-sidebar"></div>
                                        <div class="preview-content">
                                            <div class="preview-card"></div>
                                            <div class="preview-card"></div>
                                        </div>
                                    </div>
                                    <span class="theme-name">Dark Mode</span>
                                    @if (_selectedTheme == ThemeDark)
                                    {
                                        <span class="oi oi-check theme-check"></span>
                                    }
                                </button>
                                <button class="theme-option system-option @(_selectedTheme == ThemeSystem ? "selected" : "")"
                                        @onclick="SelectSystemTheme">
                                    <div class="theme-preview system-preview">
                                        <div class="preview-half light-half">
                                            <div class="preview-sidebar"></div>
                                        </div>
                                        <div class="preview-half dark-half">
                                            <div class="preview-sidebar"></div>
                                        </div>
                                    </div>
                                    <span class="theme-name">Match System</span>
                                    @if (_selectedTheme == ThemeSystem)
                                    {
                                        <span class="oi oi-check theme-check"></span>
                                    }
                                </button>
                            </div>
                        </div>
                        break;

                    case 1:
                        @* Accessibility Settings *@
                        <div class="text-center animate-fade-in">
                            <div class="step-icon mb-3">
                                <span class="oi oi-text" style="font-size: 3rem; color: #8b5cf6;"></span>
                            </div>
                            <h2 class="mb-3">Reading Preferences</h2>
                            <p class="text-muted mb-4">
                                Adjust these settings for comfortable reading. Changes apply immediately.
                            </p>

                            <div class="accessibility-options">
                                <div class="accessibility-option">
                                    <label class="option-label">Text Size</label>
                                    <div class="size-selector">
                                        <button class="size-btn @(_textSize == 90 ? "selected" : "")"
                                                @onclick="() => SelectTextSize(90)">
                                            <span style="font-size: 0.85rem">A</span>
                                        </button>
                                        <button class="size-btn @(_textSize == 100 ? "selected" : "")"
                                                @onclick="() => SelectTextSize(100)">
                                            <span>A</span>
                                        </button>
                                        <button class="size-btn @(_textSize == 110 ? "selected" : "")"
                                                @onclick="() => SelectTextSize(110)">
                                            <span style="font-size: 1.1rem">A</span>
                                        </button>
                                        <button class="size-btn @(_textSize == 125 ? "selected" : "")"
                                                @onclick="() => SelectTextSize(125)">
                                            <span style="font-size: 1.25rem">A</span>
                                        </button>
                                    </div>
                                    <span class="size-label">@_textSize%</span>
                                </div>

                                <div class="accessibility-option">
                                    <label class="option-label">Reduce Motion</label>
                                    <div class="toggle-group">
                                        <button class="toggle-btn @(_reducedMotion == ReducedMotionMode.RespectSystem ? "selected" : "")"
                                                @onclick="() => SelectReducedMotion(ReducedMotionMode.RespectSystem)">
                                            System
                                        </button>
                                        <button class="toggle-btn @(_reducedMotion == ReducedMotionMode.AlwaysReduce ? "selected" : "")"
                                                @onclick="() => SelectReducedMotion(ReducedMotionMode.AlwaysReduce)">
                                            Reduce
                                        </button>
                                        <button class="toggle-btn @(_reducedMotion == ReducedMotionMode.NeverReduce ? "selected" : "")"
                                                @onclick="() => SelectReducedMotion(ReducedMotionMode.NeverReduce)">
                                            Full
                                        </button>
                                    </div>
                                </div>

                                <div class="accessibility-option">
                                    <label class="option-label">High Contrast</label>
                                    <button class="contrast-toggle @(_highContrast ? "enabled" : "")"
                                            @onclick="ToggleHighContrast">
                                        <span class="toggle-track">
                                            <span class="toggle-thumb"></span>
                                        </span>
                                        <span class="toggle-label">@(_highContrast ? "On" : "Off")</span>
                                    </button>
                                </div>
                            </div>

                            <div class="preview-text-box mt-4">
                                <p class="preview-text" style="font-size: @(_textSize)%">
                                    This is sample text to preview your settings. Adjust until it feels comfortable to read.
                                </p>
                            </div>
                        </div>
                        break;

                    case 2:
                        @* Welcome *@
                        <div class="text-center animate-fade-in">
                            <div class="welcome-icon mb-3">
                                <span class="oi oi-task" style="font-size: 4rem; color: #0d6efd;"></span>
                            </div>
                            <h2 class="mb-3">Welcome to Self Organizer</h2>
                            <p class="lead text-muted mb-4">
                                A GTD-inspired productivity app designed to help you capture, organize, and focus on what matters most.
                            </p>
                            <div class="features-grid">
                                <div class="feature-item animate-pop-in" style="animation-delay: 0.1s">
                                    <span class="oi oi-inbox"></span>
                                    <span>Quick Capture</span>
                                </div>
                                <div class="feature-item animate-pop-in" style="animation-delay: 0.2s">
                                    <span class="oi oi-calendar"></span>
                                    <span>Smart Scheduling</span>
                                </div>
                                <div class="feature-item animate-pop-in" style="animation-delay: 0.3s">
                                    <span class="oi oi-target"></span>
                                    <span>Goal Tracking</span>
                                </div>
                                <div class="feature-item animate-pop-in" style="animation-delay: 0.4s">
                                    <span class="oi oi-graph"></span>
                                    <span>Life Balance</span>
                                </div>
                            </div>
                        </div>
                        break;

                    case 3:
                        @* App Mode Selection *@
                        <div class="text-center animate-fade-in">
                            <div class="step-icon mb-3">
                                <span class="oi oi-dial" style="font-size: 3rem; color: #0d6efd;"></span>
                            </div>
                            <h2 class="mb-3">How Will You Use Self Organizer?</h2>
                            <p class="text-muted mb-4">
                                Choose your focus to personalize your experience with relevant contexts and balance dimensions.
                            </p>
                            <div class="mode-selection">
                                <button class="mode-card @(_selectedMode == AppMode.Work ? "selected" : "")"
                                        @onclick="() => SelectMode(AppMode.Work)">
                                    <div class="mode-icon work-gradient">
                                        <span class="oi oi-briefcase"></span>
                                    </div>
                                    <div class="mode-info">
                                        <h4>Work Mode</h4>
                                        <p>Career-focused contexts like deep work, meetings, and 1-on-1s. Track professional growth dimensions.</p>
                                    </div>
                                    @if (_selectedMode == AppMode.Work)
                                    {
                                        <span class="oi oi-check mode-check"></span>
                                    }
                                </button>
                                <button class="mode-card @(_selectedMode == AppMode.Life ? "selected" : "")"
                                        @onclick="() => SelectMode(AppMode.Life)">
                                    <div class="mode-icon life-gradient">
                                        <span class="oi oi-heart"></span>
                                    </div>
                                    <div class="mode-info">
                                        <h4>Life Mode</h4>
                                        <p>Personal contexts like home, errands, and weekends. Balance health, relationships, and recreation.</p>
                                    </div>
                                    @if (_selectedMode == AppMode.Life)
                                    {
                                        <span class="oi oi-check mode-check"></span>
                                    }
                                </button>
                                <button class="mode-card @(_selectedMode == AppMode.Balanced ? "selected" : "")"
                                        @onclick="() => SelectMode(AppMode.Balanced)">
                                    <div class="mode-icon balanced-gradient">
                                        <span class="oi oi-infinity"></span>
                                    </div>
                                    <div class="mode-info">
                                        <h4>Balanced Mode</h4>
                                        <p>Best of both worlds. A curated mix of work and life contexts with 10 key balance dimensions.</p>
                                    </div>
                                    @if (_selectedMode == AppMode.Balanced)
                                    {
                                        <span class="oi oi-check mode-check"></span>
                                    }
                                </button>
                            </div>
                        </div>
                        break;

                    case 4:
                        @* Mode Preview *@
                        <div class="text-center animate-fade-in">
                            <div class="step-icon mb-3">
                                <span class="oi oi-eye" style="font-size: 3rem; color: #06b6d4;"></span>
                            </div>
                            <h2 class="mb-3">Your @(_selectedMode) Setup</h2>
                            <p class="text-muted mb-4">
                                Here's what we'll set up for you. You can customize these later in Settings.
                            </p>

                            <div class="preview-section">
                                <h5 class="preview-title">
                                    <span class="oi oi-tag me-2"></span>Contexts
                                </h5>
                                <div class="context-preview-grid">
                                    @foreach (var (name, icon, color) in _previewContexts.Take(8))
                                    {
                                        <span class="context-badge animate-pop-in" style="background-color: @color">
                                            @name
                                        </span>
                                    }
                                </div>
                            </div>

                            <div class="preview-section mt-4">
                                <h5 class="preview-title">
                                    <span class="oi oi-pie-chart me-2"></span>Balance Dimensions
                                </h5>
                                <div class="dimension-preview-grid">
                                    @foreach (var dim in _previewDimensions.Take(6))
                                    {
                                        <div class="dimension-preview-item animate-pop-in" style="border-left-color: @dim.Color">
                                            <span class="dimension-name">@dim.Name</span>
                                        </div>
                                    }
                                </div>
                                @if (_previewDimensions.Count > 6)
                                {
                                    <p class="text-muted small mt-2">+ @(_previewDimensions.Count - 6) more dimensions</p>
                                }
                            </div>
                        </div>
                        break;

                    case 5:
                        @* Capture Flow *@
                        <div class="text-center animate-fade-in">
                            <div class="step-icon mb-3">
                                <span class="oi oi-inbox" style="font-size: 3rem; color: #22c55e;"></span>
                            </div>
                            <h2 class="mb-3">Capture Everything</h2>
                            <p class="text-muted mb-4">
                                Get things out of your head and into your inbox. Quick capture lets you jot down thoughts, tasks, and ideas instantly.
                            </p>
                            <div class="workflow-steps">
                                <div class="workflow-step animate-slide-in" style="animation-delay: 0.1s">
                                    <div class="workflow-number">1</div>
                                    <div class="workflow-text">
                                        <strong>Capture</strong>
                                        <small>Write it down quickly</small>
                                    </div>
                                </div>
                                <div class="workflow-arrow">
                                    <span class="oi oi-arrow-right"></span>
                                </div>
                                <div class="workflow-step animate-slide-in" style="animation-delay: 0.2s">
                                    <div class="workflow-number">2</div>
                                    <div class="workflow-text">
                                        <strong>Clarify</strong>
                                        <small>Process your inbox</small>
                                    </div>
                                </div>
                                <div class="workflow-arrow">
                                    <span class="oi oi-arrow-right"></span>
                                </div>
                                <div class="workflow-step animate-slide-in" style="animation-delay: 0.3s">
                                    <div class="workflow-number">3</div>
                                    <div class="workflow-text">
                                        <strong>Organize</strong>
                                        <small>Put it where it belongs</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        break;

                    case 6:
                        @* Calendar Provider *@
                        <div class="text-center animate-fade-in">
                            <div class="step-icon mb-3">
                                <span class="oi oi-calendar" style="font-size: 3rem; color: #06b6d4;"></span>
                            </div>
                            <h2 class="mb-3">Calendar Integration</h2>
                            <p class="text-muted mb-4">
                                Connect your calendar to sync meetings and schedule tasks around your existing commitments.
                            </p>
                            <div class="provider-selection">
                                <button class="provider-option @(_selectedProvider == CalendarProvider.Google ? "selected" : "")"
                                        @onclick="() => SelectProvider(CalendarProvider.Google)">
                                    <div class="provider-icon google-icon">G</div>
                                    <span class="provider-name">Google Calendar</span>
                                    @if (_selectedProvider == CalendarProvider.Google)
                                    {
                                        <span class="oi oi-check selected-check"></span>
                                    }
                                </button>
                                <button class="provider-option @(_selectedProvider == CalendarProvider.Outlook ? "selected" : "")"
                                        @onclick="() => SelectProvider(CalendarProvider.Outlook)">
                                    <div class="provider-icon outlook-icon">O</div>
                                    <span class="provider-name">Outlook Calendar</span>
                                    @if (_selectedProvider == CalendarProvider.Outlook)
                                    {
                                        <span class="oi oi-check selected-check"></span>
                                    }
                                </button>
                                <button class="provider-option skip-option @(_selectedProvider == CalendarProvider.None ? "selected" : "")"
                                        @onclick="() => SelectProvider(CalendarProvider.None)">
                                    <div class="provider-icon skip-icon">
                                        <span class="oi oi-x"></span>
                                    </div>
                                    <span class="provider-name">Skip for now</span>
                                    @if (_selectedProvider == CalendarProvider.None)
                                    {
                                        <span class="oi oi-check selected-check"></span>
                                    }
                                </button>
                            </div>
                            <p class="text-muted small mt-3">
                                You can connect your calendar later in Settings.
                            </p>
                        </div>
                        break;

                    case 7:
                        @* Balance Areas Selection *@
                        <div class="text-center animate-fade-in">
                            <div class="step-icon mb-3">
                                <span class="oi oi-pie-chart" style="font-size: 3rem; color: #eab308;"></span>
                            </div>
                            <h2 class="mb-3">Track Your Balance</h2>
                            <p class="text-muted mb-4">
                                Select the life areas you want to track. These will appear in your Balance Wheel.
                            </p>
                            <div class="life-area-grid">
                                @foreach (var dim in _previewDimensions)
                                {
                                    var isEnabled = _enabledDimensions.Contains(dim.Id);
                                    <button class="life-area-item @(isEnabled ? "enabled" : "")"
                                            @onclick="() => ToggleDimension(dim.Id)"
                                            style="--dim-color: @dim.Color">
                                        <div class="area-indicator" style="background-color: @dim.Color"></div>
                                        <span class="area-name">@dim.Name</span>
                                        @if (isEnabled)
                                        {
                                            <span class="oi oi-check area-check"></span>
                                        }
                                    </button>
                                }
                            </div>
                            <p class="text-muted small mt-3">
                                <span class="oi oi-info me-1"></span>
                                @_enabledDimensions.Count of @_previewDimensions.Count selected
                            </p>
                        </div>
                        break;

                    case 8:
                        @* Get Started *@
                        <div class="text-center animate-fade-in">
                            <div class="step-icon mb-3 animate-bounce">
                                <span class="oi oi-bolt" style="font-size: 3rem; color: #22c55e;"></span>
                            </div>
                            <h2 class="mb-3">You're All Set!</h2>
                            <p class="text-muted mb-4">
                                Start by capturing your first thought or task. Remember: getting things out of your head is the first step to staying organized.
                            </p>
                            <div class="tip-box">
                                <strong>Pro Tips:</strong>
                                <ul class="tip-list">
                                    <li>Press <kbd>C</kbd> anywhere to quickly capture a new item</li>
                                    <li>Press <kbd>?</kbd> to see all keyboard shortcuts</li>
                                    <li>Check your Balance Wheel regularly in Reports</li>
                                </ul>
                            </div>
                        </div>
                        break;
                }
            </div>

            @* Navigation *@
            <div class="wizard-navigation mt-4">
                @if (_currentStep > 0)
                {
                    <button class="btn btn-outline-secondary" @onclick="PreviousStep">
                        <span class="oi oi-arrow-left me-1"></span> Back
                    </button>
                }
                else
                {
                    <div></div>
                }

                @if (_currentStep < TotalSteps - 1)
                {
                    <button class="btn btn-primary" @onclick="NextStep">
                        Next <span class="oi oi-arrow-right ms-1"></span>
                    </button>
                }
                else
                {
                    <button class="btn btn-success btn-lg" @onclick="CompleteOnboarding" disabled="@_isCompleting">
                        @if (_isCompleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Setting up...</span>
                        }
                        else
                        {
                            <span class="oi oi-check me-1"></span>
                            <span>Get Started</span>
                        }
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnCompleted { get; set; }

    // Theme constants
    private const string ThemeLight = "light";
    private const string ThemeDark = "dark";
    private const string ThemeSystem = "system";

    private const int TotalSteps = 9;
    private int _currentStep = 0;
    private CalendarProvider _selectedProvider = CalendarProvider.None;
    private AppMode _selectedMode = AppMode.Balanced;
    private List<(string Name, string Icon, string Color)> _previewContexts = new();
    private List<BalanceDimension> _previewDimensions = new();
    private HashSet<string> _enabledDimensions = new();
    private bool _isCompleting = false;
    private string _animationClass = "";
    private string _stepAnimationClass = "";

    // Accessibility settings
    private string _selectedTheme = "system";
    private int _textSize = 100;
    private ReducedMotionMode _reducedMotion = ReducedMotionMode.RespectSystem;
    private bool _highContrast = false;
    private UserPreferences? _preferences;

    protected override async Task OnInitializedAsync()
    {
        // Load or create preferences
        _preferences = (await PreferencesRepository.GetAllAsync()).FirstOrDefault();
        if (_preferences == null)
        {
            _preferences = new UserPreferences();
            await PreferencesRepository.AddAsync(_preferences);
        }

        // Initialize accessibility settings from preferences
        if (_preferences.Accessibility != null)
        {
            _textSize = _preferences.Accessibility.TextScalingPercent;
            _reducedMotion = _preferences.Accessibility.ReducedMotionMode;
            _highContrast = _preferences.Accessibility.HighContrastMode;
        }

        // Get current theme
        _selectedTheme = await ThemeService.GetThemeAsync();

        await UpdatePreviews();
    }

    private string GetStepLabel(int step) => step switch
    {
        0 => "Theme",
        1 => "Access",
        2 => "Welcome",
        3 => "Mode",
        4 => "Preview",
        5 => "Capture",
        6 => "Calendar",
        7 => "Balance",
        8 => "Start",
        _ => ""
    };

    private void GoToStep(int step)
    {
        if (step <= _currentStep)
        {
            _currentStep = step;
        }
    }

    private async Task NextStep()
    {
        if (_currentStep < TotalSteps - 1)
        {
            _stepAnimationClass = "animate-slide-out";
            await Task.Delay(150);
            _currentStep++;
            _stepAnimationClass = "animate-slide-in";
            StateHasChanged();
            await Task.Delay(300);
            _stepAnimationClass = "";
        }
    }

    private async Task PreviousStep()
    {
        if (_currentStep > 0)
        {
            _stepAnimationClass = "animate-slide-out-reverse";
            await Task.Delay(150);
            _currentStep--;
            _stepAnimationClass = "animate-slide-in-reverse";
            StateHasChanged();
            await Task.Delay(300);
            _stepAnimationClass = "";
        }
    }

    private async Task SelectLightTheme() => await SelectTheme(ThemeLight);
    private async Task SelectDarkTheme() => await SelectTheme(ThemeDark);
    private async Task SelectSystemTheme() => await SelectTheme(ThemeSystem);

    private async Task SelectTheme(string theme)
    {
        _selectedTheme = theme;

        // Apply theme immediately
        if (theme == ThemeSystem)
        {
            await ThemeService.UseSystemThemeAsync();
        }
        else
        {
            await ThemeService.SetThemeAsync(theme);
        }

        await SavePreferences();
    }

    private async Task SelectTextSize(int size)
    {
        _textSize = size;
        await SaveAccessibilitySettings();
    }

    private async Task SelectReducedMotion(ReducedMotionMode mode)
    {
        _reducedMotion = mode;
        await SaveAccessibilitySettings();
    }

    private async Task ToggleHighContrast()
    {
        _highContrast = !_highContrast;
        await SaveAccessibilitySettings();
    }

    private async Task SaveAccessibilitySettings()
    {
        if (_preferences == null) return;

        _preferences.Accessibility ??= new AccessibilitySettings();
        _preferences.Accessibility.TextScalingPercent = _textSize;
        _preferences.Accessibility.ReducedMotionMode = _reducedMotion;
        _preferences.Accessibility.HighContrastMode = _highContrast;

        await PreferencesRepository.UpdateAsync(_preferences);
    }

    private async Task SavePreferences()
    {
        if (_preferences == null) return;
        await PreferencesRepository.UpdateAsync(_preferences);
    }

    private void SelectProvider(CalendarProvider provider)
    {
        _selectedProvider = provider;
    }

    private async Task SelectMode(AppMode mode)
    {
        _selectedMode = mode;
        await UpdatePreviews();
    }

    private async Task UpdatePreviews()
    {
        // Get contexts for selected mode
        _previewContexts = ContextService.GetContextDefinitionsForMode(_selectedMode).ToList();

        // Get balance dimensions for selected mode
        _previewDimensions = (await BalanceDimensionService.GetDimensionsForModeAsync(_selectedMode)).ToList();

        // Enable all dimensions by default
        _enabledDimensions = _previewDimensions.Select(d => d.Id).ToHashSet();
    }

    private void ToggleDimension(string dimensionId)
    {
        if (_enabledDimensions.Contains(dimensionId))
        {
            // Don't allow deselecting all
            if (_enabledDimensions.Count > 1)
            {
                _enabledDimensions.Remove(dimensionId);
            }
        }
        else
        {
            _enabledDimensions.Add(dimensionId);
        }
    }

    private async Task CompleteOnboarding()
    {
        _isCompleting = true;
        StateHasChanged();

        try
        {
            if (_preferences == null)
            {
                _preferences = new UserPreferences();
            }

            // Save all preferences
            _preferences.OnboardingCompleted = true;
            _preferences.PreferredCalendarProvider = _selectedProvider;
            _preferences.AppMode = _selectedMode;
            _preferences.AppModeSetAt = DateTime.UtcNow;
            _preferences.EnabledBalanceDimensions = _enabledDimensions.ToList();

            // Ensure accessibility settings are saved
            _preferences.Accessibility ??= new AccessibilitySettings();
            _preferences.Accessibility.TextScalingPercent = _textSize;
            _preferences.Accessibility.ReducedMotionMode = _reducedMotion;
            _preferences.Accessibility.HighContrastMode = _highContrast;

            await PreferencesRepository.UpdateAsync(_preferences);

            // Seed contexts for the selected mode
            await ContextService.SeedContextsForModeAsync(_selectedMode);

            // Seed sample data to help users explore the app
            await SampleDataService.SeedSampleDataAsync();

            // Small delay for visual feedback
            await Task.Delay(500);

            await OnCompleted.InvokeAsync();
        }
        finally
        {
            _isCompleting = false;
        }
    }
}
