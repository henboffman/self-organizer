@using SelfOrganizer.Core.Models

@code {
    [Parameter] public TodoTask Task { get; set; } = default!;
    [Parameter] public EventCallback<TodoTask> OnComplete { get; set; }
    [Parameter] public EventCallback<TodoTask> OnEdit { get; set; }
    [Parameter] public EventCallback<TodoTask> OnDelete { get; set; }
    [Parameter] public EventCallback<TodoTask> OnDeactivate { get; set; }
    [Parameter] public EventCallback<TodoTask> OnFocus { get; set; }
    [Parameter] public bool ShowProject { get; set; } = true;
    [Parameter] public bool ShowDeactivate { get; set; } = false;
    [Parameter] public bool ShowFocus { get; set; } = true;
    [Parameter] public bool EnableInlineEdit { get; set; } = true;

    private async Task OnTitleChanged(string newTitle)
    {
        if (!string.IsNullOrWhiteSpace(newTitle) && Task.Title != newTitle)
        {
            // Create a copy of the task with the updated title instead of mutating the parameter
            // This ensures the UI shows old data if the parent's save operation fails
            var updatedTask = new TodoTask
            {
                Id = Task.Id,
                Title = newTitle,
                Description = Task.Description,
                Status = Task.Status,
                Priority = Task.Priority,
                EstimatedMinutes = Task.EstimatedMinutes,
                ActualMinutes = Task.ActualMinutes,
                DueDate = Task.DueDate,
                ScheduledDate = Task.ScheduledDate,
                ScheduledStartTime = Task.ScheduledStartTime,
                Contexts = Task.Contexts.ToList(),
                Tags = Task.Tags.ToList(),
                Category = Task.Category,
                EnergyLevel = Task.EnergyLevel,
                RequiresDeepWork = Task.RequiresDeepWork,
                ProjectId = Task.ProjectId,
                GoalIds = Task.GoalIds.ToList(),
                ParentTaskId = Task.ParentTaskId,
                SubtaskIds = Task.SubtaskIds.ToList(),
                BlockedByTaskIds = Task.BlockedByTaskIds.ToList(),
                LinkedTaskIds = Task.LinkedTaskIds.ToList(),
                LinkedMeetingIds = Task.LinkedMeetingIds.ToList(),
                IsRecurring = Task.IsRecurring,
                RecurrencePattern = Task.RecurrencePattern,
                RecurrenceIntervalDays = Task.RecurrenceIntervalDays,
                LastRecurrenceDate = Task.LastRecurrenceDate,
                Links = Task.Links.ToList(),
                WhoFor = Task.WhoFor,
                WaitingForContactId = Task.WaitingForContactId,
                WaitingForNote = Task.WaitingForNote,
                WaitingForSince = Task.WaitingForSince,
                Icon = Task.Icon,
                IsIconAutoDetected = Task.IsIconAutoDetected,
                DetectedCategory = Task.DetectedCategory,
                Notes = Task.Notes,
                CreatedAt = Task.CreatedAt,
                ModifiedAt = DateTime.UtcNow,
                CompletedAt = Task.CompletedAt
            };

            // Let the parent handle the update; if it succeeds, the parent will refresh the task list
            // If it fails, the original Task parameter remains unchanged
            await OnEdit.InvokeAsync(updatedTask);
        }
    }
}

<div class="card task-card mb-2">
    <div class="card-body py-2 px-3">
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-success me-2" @onclick="() => OnComplete.InvokeAsync(Task)" title="Complete" aria-label="Complete task">
                <span class="oi oi-check" aria-hidden="true"></span>
            </button>
            <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                    <TaskIcon Task="@Task" Size="IconDisplay.IconSize.Small" />
                    <PriorityIndicator Priority="@Task.Priority" CssClass="ms-1" />
                    @if (EnableInlineEdit)
                    {
                        <div class="task-title-wrapper ms-2">
                            <InlineEdit TValue="string"
                                        Value="@Task.Title"
                                        OnSave="OnTitleChanged"
                                        Placeholder="Task title">
                                <DisplayTemplate>
                                    <TaggedText Text="@Task.Title" />
                                </DisplayTemplate>
                            </InlineEdit>
                            <a href="tasks/@Task.Id" class="task-detail-link ms-1" title="View details">
                                <span class="oi oi-external-link"></span>
                            </a>
                        </div>
                    }
                    else
                    {
                        <a href="tasks/@Task.Id" class="task-title ms-2 text-decoration-none">
                            <TaggedText Text="@Task.Title" />
                        </a>
                    }
                </div>
                <div class="task-meta small text-muted">
                    @if (Task.EstimatedMinutes > 0)
                    {
                        <TimeDisplay Minutes="@Task.EstimatedMinutes" />
                        <span class="mx-1">|</span>
                    }
                    @{var cardContexts = Task.Contexts ?? new List<string>();}
                    @if (cardContexts.Any())
                    {
                        @foreach (var context in cardContexts)
                        {
                            <ContextBadge Context="@context" />
                        }
                    }
                    @if (!string.IsNullOrEmpty(Task.Category))
                    {
                        <CategoryBadge Category="@Task.Category" />
                    }
                    @if (Task.DueDate.HasValue)
                    {
                        <span class="ms-2 @(Task.DueDate.Value < DateTime.UtcNow ? "text-danger" : "")">
                            <span class="oi oi-calendar"></span> @Task.DueDate.Value.ToString("MMM d")
                        </span>
                    }
                </div>
            </div>
            <div class="task-actions">
                @if (ShowFocus && OnFocus.HasDelegate)
                {
                    <button class="btn btn-sm btn-link text-primary" @onclick="() => OnFocus.InvokeAsync(Task)" title="Focus on this task" aria-label="Focus on this task">
                        <span class="oi oi-target" aria-hidden="true"></span>
                    </button>
                }
                @if (ShowDeactivate)
                {
                    <button class="btn btn-sm btn-link text-warning" @onclick="() => OnDeactivate.InvokeAsync(Task)" title="Move back to Inbox" aria-label="Move back to Inbox">
                        <span class="oi oi-action-undo" aria-hidden="true"></span>
                    </button>
                }
                <button class="btn btn-sm btn-link text-secondary" @onclick="() => OnEdit.InvokeAsync(Task)" title="Edit" aria-label="Edit task">
                    <span class="oi oi-pencil" aria-hidden="true"></span>
                </button>
                <button class="btn btn-sm btn-link text-danger" @onclick="() => OnDelete.InvokeAsync(Task)" title="Delete" aria-label="Delete task">
                    <span class="oi oi-trash" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div>
