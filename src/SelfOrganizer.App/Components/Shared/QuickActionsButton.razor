@using SelfOrganizer.Core.Models
@using SelfOrganizer.App.Services
@inject NavigationManager NavigationManager
@inject SelfOrganizer.App.Services.IFocusTimerState FocusTimerService
@inject SelfOrganizer.Core.Interfaces.IRepository<CaptureItem> CaptureRepository
@inject SelfOrganizer.App.Services.IDataChangeNotificationService DataChangeNotification
@implements IDisposable

<div class="fab-container @(_isExpanded ? "expanded" : "")">
    @if (_isExpanded)
    {
        <div class="fab-backdrop" @onclick="ToggleExpanded"></div>

        <div class="fab-menu">
            @foreach (var action in GetContextualActions())
            {
                <button class="fab-item @(action.IsPrimary ? "primary" : "")"
                        @onclick="() => ExecuteAction(action)"
                        title="@action.Label">
                    <span class="oi @action.Icon"></span>
                    <span class="fab-label">@action.Label</span>
                    @if (!string.IsNullOrEmpty(action.Shortcut))
                    {
                        <span class="fab-shortcut">@action.Shortcut</span>
                    }
                </button>
            }
        </div>
    }

    @* Focus Timer Mini - shows when timer is running *@
    @if (_focusState.TaskTitle != null && _focusState.IsRunning)
    {
        <button class="fab-focus @(_focusState.IsBreak ? "break" : "")"
                @onclick='() => NavigateTo("focus")'
                title="Focus Timer">
            <span class="focus-time">@FormatTime(_focusState.RemainingSeconds)</span>
        </button>
    }

    @* Inbox Badge - shows if items pending *@
    @if (_inboxCount > 0)
    {
        <button class="fab-badge"
                @onclick='() => NavigateTo("inbox")'
                title="@_inboxCount items in inbox">
            <span class="oi oi-inbox"></span>
            <span class="badge-count">@_inboxCount</span>
        </button>
    }

    <button class="fab-main @(_isExpanded ? "active" : "")" @onclick="ToggleExpanded" title="Quick Actions">
        <span class="fab-icon oi @(_isExpanded ? "oi-x" : "oi-plus")"></span>
    </button>
</div>

@code {
    private bool _isExpanded = false;
    private FocusTimerStateData _focusState = new();
    private int _inboxCount = 0;
    private string _currentPath = "";

    protected override async Task OnInitializedAsync()
    {
        await FocusTimerService.InitializeAsync();
        _focusState = FocusTimerService.State;
        FocusTimerService.OnStateChanged += OnFocusStateChanged;
        NavigationManager.LocationChanged += OnLocationChanged;
        DataChangeNotification.OnDataChanged += OnDataChangedHandler;
        _currentPath = GetCurrentPath();

        await LoadInboxCount();
    }

    private async Task LoadInboxCount()
    {
        var captures = await CaptureRepository.GetAllAsync();
        _inboxCount = captures.Count(c => !c.IsProcessed);
    }

    private void OnFocusStateChanged()
    {
        _focusState = FocusTimerService.State;
        InvokeAsync(StateHasChanged);
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        _currentPath = GetCurrentPath();
        InvokeAsync(StateHasChanged);
    }

    private async void OnDataChangedHandler()
    {
        try
        {
            await InvokeAsync(async () =>
            {
                await LoadInboxCount();
                StateHasChanged();
            });
        }
        catch (ObjectDisposedException)
        {
            // Component was disposed while handling data change
        }
        catch (Exception)
        {
            // Log error but don't crash - data will be stale until next refresh
        }
    }

    private string GetCurrentPath()
    {
        var uri = new Uri(NavigationManager.Uri);
        return uri.AbsolutePath.ToLowerInvariant().TrimEnd('/');
    }

    private void ToggleExpanded()
    {
        _isExpanded = !_isExpanded;
    }

    private void NavigateTo(string path)
    {
        NavigationManager.NavigateTo(path);
        _isExpanded = false;
    }

    private void ExecuteAction(ActionItem action)
    {
        if (!string.IsNullOrEmpty(action.NavigateTo))
        {
            NavigateTo(action.NavigateTo);
        }
        _isExpanded = false;
    }

    private List<ActionItem> GetContextualActions()
    {
        var actions = new List<ActionItem>();

        // Context-specific actions based on current page
        if (_currentPath.Contains("tasks"))
        {
            actions.Add(new("Review Day", "oi-check", "review/daily", null, false));
        }
        else if (_currentPath.Contains("calendar"))
        {
            actions.Add(new("Today", "oi-home", "calendar?view=day&date=" + DateTime.Today.ToString("yyyy-MM-dd"), "t", false));
        }
        else if (_currentPath.Contains("goals"))
        {
            actions.Add(new("New Goal", "oi-target", "goals?new=true", null, false));
        }

        // Standard actions (in reverse order for proper stacking)
        actions.Add(new("Focus Timer", "oi-clock", "focus", "f", false));
        actions.Add(new("Daily Review", "oi-check", "review/daily", null, false));
        actions.Add(new("New Goal", "oi-target", "goals?new=true", null, false));
        actions.Add(new("New Project", "oi-folder", "projects?new=true", null, false));
        actions.Add(new("New Idea", "oi-lightbulb", "ideas?new=true", null, false));
        actions.Add(new("Quick Capture", "oi-bolt", "capture", "c", true));

        // Remove duplicates and take max 6
        return actions.DistinctBy(a => a.NavigateTo).Take(6).ToList();
    }

    private static string FormatTime(int totalSeconds)
    {
        var minutes = totalSeconds / 60;
        var seconds = totalSeconds % 60;
        return $"{minutes:D2}:{seconds:D2}";
    }

    public void Dispose()
    {
        FocusTimerService.OnStateChanged -= OnFocusStateChanged;
        NavigationManager.LocationChanged -= OnLocationChanged;
        DataChangeNotification.OnDataChanged -= OnDataChangedHandler;
    }

    private record ActionItem(string Label, string Icon, string NavigateTo, string? Shortcut, bool IsPrimary);
}
