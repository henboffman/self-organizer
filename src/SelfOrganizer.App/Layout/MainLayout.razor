@inherits LayoutComponentBase
@implements IDisposable
@using SelfOrganizer.Core.Models
@using SelfOrganizer.Core.Interfaces
@inject IRepository<UserPreferences> PreferencesRepository
@inject IEntraAuthService EntraAuthService

<a href="#main-content" class="skip-to-main visually-hidden-focusable">Skip to main content</a>
<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main id="main-content">
        <div class="top-row px-4">
            <div class="me-auto">
                <SelfOrganizer.App.Components.FocusTimer.FocusTimerIndicator />
            </div>
            <button class="btn btn-outline-secondary btn-sm" @onclick="OpenGlobalSearch" title="Search (Cmd+Shift+Space)">
                <span class="oi oi-magnifying-glass"></span>
            </button>
            <a href="capture" class="btn btn-outline-primary btn-sm">
                <span class="oi oi-plus"></span> Quick Capture
            </a>
            <a href="settings" class="settings-link">Settings</a>
            @if (EntraAuthService.State == AuthState.Authenticated && EntraAuthService.CurrentUser != null)
            {
                <span class="user-greeting" title="@EntraAuthService.CurrentUser.Email">
                    <span class="oi oi-person"></span>
                    @EntraAuthService.CurrentUser.DisplayName
                </span>
            }
            <SelfOrganizer.App.Components.Shared.ThemeToggle />
        </div>

        <article class="content px-4">
            <ErrorBoundary @ref="_errorBoundary">
                <ChildContent>
                    @Body
                </ChildContent>
                <ErrorContent Context="exception">
                    <SelfOrganizer.App.Components.Shared.ErrorContent
                        Exception="@exception"
                        OnRecover="RecoverFromError" />
                </ErrorContent>
            </ErrorBoundary>
        </article>
    </main>
</div>

<SelfOrganizer.App.Components.Onboarding.OnboardingWizard
    IsVisible="_showOnboarding"
    OnCompleted="OnOnboardingCompleted" />

<SelfOrganizer.App.Components.Shared.GlobalSearch
    @bind-IsVisible="_showGlobalSearch"
    OnClose="OnGlobalSearchClosed" />

<SelfOrganizer.App.Components.Shared.KeyboardShortcutsHelp
    IsVisible="_showKeyboardHelp"
    OnClose="OnKeyboardHelpClosed" />

<SelfOrganizer.App.Components.Shared.QuickAdd
    IsVisible="_showQuickAdd"
    OnClose="OnQuickAddClosed" />

<SelfOrganizer.App.Components.Shared.QuickActionsButton />

<SelfOrganizer.App.Components.Shared.ToastContainer />
