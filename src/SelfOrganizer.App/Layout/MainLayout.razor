@inherits LayoutComponentBase
@using SelfOrganizer.Core.Models
@using SelfOrganizer.Core.Interfaces
@inject IRepository<UserPreferences> PreferencesRepository

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <a href="/capture" class="btn btn-outline-primary btn-sm me-3">
                <span class="oi oi-plus"></span> Quick Capture
            </a>
            <a href="/settings" class="settings-link">Settings</a>
            <SelfOrganizer.App.Components.Shared.ThemeToggle />
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<SelfOrganizer.App.Components.Onboarding.OnboardingWizard
    IsVisible="_showOnboarding"
    OnCompleted="OnOnboardingCompleted" />

@code {
    private bool _showOnboarding = false;
    private bool _checkedOnboarding = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_checkedOnboarding)
        {
            _checkedOnboarding = true;
            var prefs = (await PreferencesRepository.GetAllAsync()).FirstOrDefault();
            if (prefs == null || !prefs.OnboardingCompleted)
            {
                _showOnboarding = true;
                StateHasChanged();
            }
        }
    }

    private void OnOnboardingCompleted()
    {
        _showOnboarding = false;
    }
}
