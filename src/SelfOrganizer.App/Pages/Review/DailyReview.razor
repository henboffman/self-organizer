@page "/review/daily"
@using SelfOrganizer.Core.Models
@inject SelfOrganizer.Core.Interfaces.ICaptureService CaptureService
@inject SelfOrganizer.Core.Interfaces.ITaskService TaskService
@inject SelfOrganizer.Core.Interfaces.IReviewService ReviewService
@inject SelfOrganizer.Core.Interfaces.ICalendarService CalendarService

<h3 class="mb-4">
    <span class="oi oi-check me-2"></span>Daily Review
</h3>

<div class="alert alert-info">
    <strong>Daily Review Checklist</strong> - Complete these steps to stay on top of your commitments.
</div>

<div class="row">
    <div class="col-lg-8">
        @* Inbox *@
        <div class="card mb-4 @(_inboxCount == 0 ? "border-success" : "border-warning")">
            <div class="card-header d-flex justify-content-between align-items-center @(_inboxCount == 0 ? "bg-success text-white" : "bg-warning")">
                <span>
                    @if (_inboxCount == 0)
                    {
                        <span class="oi oi-check me-2"></span>
                    }
                    Inbox
                </span>
                <span class="badge status-badge">@_inboxCount items</span>
            </div>
            <div class="card-body">
                @if (_inboxCount == 0)
                {
                    <p class="text-success mb-0"><strong>Inbox Zero!</strong> All captured items have been processed.</p>
                }
                else
                {
                    <p>You have @_inboxCount unprocessed items in your inbox.</p>
                    <a href="/inbox" class="btn btn-warning">Process Inbox</a>
                }
            </div>
        </div>

        @* Incomplete Scheduled Tasks *@
        <div class="card mb-4 @(!_incompleteTasks.Any() ? "border-success" : "border-warning")">
            <div class="card-header d-flex justify-content-between align-items-center @(!_incompleteTasks.Any() ? "bg-success text-white" : "bg-warning")">
                <span>Today's Incomplete Tasks</span>
                <span class="badge status-badge">@_incompleteTasks.Count items</span>
            </div>
            <div class="card-body">
                @if (!_incompleteTasks.Any())
                {
                    <p class="text-success mb-0">All scheduled tasks for today are complete!</p>
                }
                else
                {
                    <p class="text-muted">These tasks were scheduled for today but not completed:</p>
                    @foreach (var task in _incompleteTasks)
                    {
                        <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                            <div>
                                <a href="/tasks/@task.Id">@task.Title</a>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" @onclick="() => CompleteTask(task)">Complete</button>
                                <button class="btn btn-outline-primary" @onclick="() => RescheduleTask(task)">Reschedule</button>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        @* Stale Waiting For *@
        <div class="card mb-4 @(!_staleWaitingFor.Any() ? "border-success" : "border-warning")">
            <div class="card-header d-flex justify-content-between align-items-center @(!_staleWaitingFor.Any() ? "bg-success text-white" : "bg-warning")">
                <span>Stale Waiting For Items</span>
                <span class="badge status-badge">@_staleWaitingFor.Count items</span>
            </div>
            <div class="card-body">
                @if (!_staleWaitingFor.Any())
                {
                    <p class="text-success mb-0">No stale waiting-for items!</p>
                }
                else
                {
                    <p class="text-muted">These items have been waiting for more than 7 days:</p>
                    @foreach (var task in _staleWaitingFor)
                    {
                        var days = task.WaitingForSince.HasValue
                            ? (int)(DateTime.UtcNow - task.WaitingForSince.Value).TotalDays
                            : 0;
                        <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                            <div>
                                <a href="/tasks/@task.Id">@task.Title</a>
                                <small class="d-block text-muted">Waiting for @(task.WaitingForNote ?? "someone") (@days days)</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary">Follow Up</button>
                        </div>
                    }
                }
            </div>
        </div>

        @* Tomorrow's Preview *@
        <div class="card mb-4">
            <div class="card-header">
                <span class="oi oi-calendar me-2"></span>Tomorrow's Preview
            </div>
            <div class="card-body">
                @if (!_tomorrowEvents.Any())
                {
                    <p class="text-muted">No events scheduled for tomorrow.</p>
                }
                else
                {
                    @foreach (var evt in _tomorrowEvents.OrderBy(e => e.StartTime))
                    {
                        <div class="d-flex align-items-center py-2 border-bottom">
                            <span class="text-muted me-3" style="min-width: 70px;">@evt.StartTime.ToString("h:mm tt")</span>
                            <span>@evt.Title</span>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        @* Today's Stats *@
        <div class="card mb-4">
            <div class="card-header">Today's Stats</div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                    <span>Tasks Completed</span>
                    <strong class="text-success">@_completedToday</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Items Captured</span>
                    <strong>@_capturedToday</strong>
                </li>
            </ul>
        </div>

        @* Review Checklist *@
        <div class="card">
            <div class="card-header">Review Checklist</div>
            <div class="card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="check1" @bind="_checkInbox" />
                    <label class="form-check-label" for="check1">Process inbox to zero</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="check2" @bind="_checkCompleted" />
                    <label class="form-check-label" for="check2">Review completed tasks</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="check3" @bind="_checkIncomplete" />
                    <label class="form-check-label" for="check3">Reschedule incomplete items</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="check4" @bind="_checkWaiting" />
                    <label class="form-check-label" for="check4">Check waiting-for items</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="check5" @bind="_checkTomorrow" />
                    <label class="form-check-label" for="check5">Review tomorrow's calendar</label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="check6" @bind="_checkCapture" />
                    <label class="form-check-label" for="check6">Capture anything else on your mind</label>
                </div>
                <button class="btn btn-success w-100" @onclick="MarkReviewComplete" disabled="@(!AllChecked)">
                    <span class="oi oi-check me-1"></span> Complete Daily Review
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private int _inboxCount = 0;
    private int _completedToday = 0;
    private int _capturedToday = 0;
    private List<TodoTask> _incompleteTasks = new();
    private List<TodoTask> _staleWaitingFor = new();
    private List<CalendarEvent> _tomorrowEvents = new();

    private bool _checkInbox = false;
    private bool _checkCompleted = false;
    private bool _checkIncomplete = false;
    private bool _checkWaiting = false;
    private bool _checkTomorrow = false;
    private bool _checkCapture = false;

    private bool AllChecked => _checkInbox && _checkCompleted && _checkIncomplete && _checkWaiting && _checkTomorrow && _checkCapture;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _inboxCount = await CaptureService.GetUnprocessedCountAsync();
        _completedToday = await TaskService.GetCompletedTodayCountAsync();
        _capturedToday = await CaptureService.GetTodayCaptureCountAsync();
        _incompleteTasks = (await ReviewService.GetIncompleteScheduledTasksAsync(DateOnly.FromDateTime(DateTime.Today))).ToList();
        _staleWaitingFor = (await ReviewService.GetStaleWaitingForItemsAsync()).ToList();
        _tomorrowEvents = (await CalendarService.GetEventsForDateAsync(DateOnly.FromDateTime(DateTime.Today.AddDays(1)))).ToList();

        // Auto-check if conditions are met
        _checkInbox = _inboxCount == 0;
        _checkIncomplete = !_incompleteTasks.Any();
        _checkWaiting = !_staleWaitingFor.Any();
    }

    private async Task CompleteTask(TodoTask task)
    {
        await TaskService.CompleteAsync(task.Id);
        await LoadData();
    }

    private async Task RescheduleTask(TodoTask task)
    {
        await TaskService.ScheduleAsync(task.Id, DateTime.Today.AddDays(1));
        await LoadData();
    }

    private async Task MarkReviewComplete()
    {
        await ReviewService.MarkDailyReviewCompletedAsync(DateOnly.FromDateTime(DateTime.Today));
    }
}
