@page "/focus"
@using SelfOrganizer.Core.Models
@using SelfOrganizer.App.Services
@using SelfOrganizer.App.Components.Shared
@inject SelfOrganizer.Core.Interfaces.ITaskService TaskService
@inject SelfOrganizer.Core.Interfaces.IRepository<UserPreferences> PreferencesRepository
@inject IDataChangeNotificationService DataChangeNotification
@inject IJSRuntime JS
@implements IDisposable

<div class="focus-container">
    @if (_selectedTask == null)
    {
        <div class="text-center py-5">
            <h2 class="mb-4">
                <span class="oi oi-clock me-2"></span>Focus Timer
            </h2>
            <p class="text-muted mb-4">Select a task to focus on, or start a free focus session.</p>

            @if (_availableTasks.Any())
            {
                <div class="mb-4">
                    <h5 class="mb-3">Pick a task:</h5>
                    <div class="list-group" style="max-width: 500px; margin: 0 auto;">
                        @foreach (var task in _availableTasks.Take(5))
                        {
                            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    @onclick="() => SelectTask(task)">
                                <span>@task.Title</span>
                                @if (task.EstimatedMinutes > 0)
                                {
                                    <span class="badge bg-secondary">@task.EstimatedMinutes min</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            }

            <button class="btn btn-lg btn-outline-primary" @onclick="StartFreeSession">
                <span class="oi oi-media-play me-2"></span>Start Free Focus Session
            </button>
        </div>
    }
    else
    {
        <div class="text-center">
            @* Current Task *@
            <div class="mb-4">
                <span class="badge bg-primary fs-6 px-3 py-2">
                    @(_selectedTask.Title == "Free Focus" ? "Free Focus Session" : _selectedTask.Title)
                </span>
            </div>

            @* Timer Display *@
            <div class="timer-display mb-4">
                <div class="timer-digits @(_isBreak ? "text-success" : "")">
                    @FormatTime(_remainingSeconds)
                </div>
                <div class="timer-label text-muted">
                    @if (_isBreak)
                    {
                        <span class="text-success">Break Time!</span>
                    }
                    else if (_isRunning)
                    {
                        <span>Focus...</span>
                    }
                    else if (_remainingSeconds == _focusMinutes * 60)
                    {
                        <span>Ready to start</span>
                    }
                    else
                    {
                        <span>Paused</span>
                    }
                </div>
            </div>

            @* Progress Ring *@
            <div class="progress-container mb-4">
                <svg class="progress-ring" viewBox="0 0 120 120">
                    <circle class="progress-ring-bg" cx="60" cy="60" r="54" />
                    <circle class="progress-ring-fill @(_isBreak ? "break" : "")"
                            cx="60" cy="60" r="54"
                            stroke-dasharray="@(2 * Math.PI * 54)"
                            stroke-dashoffset="@GetProgressOffset()" />
                </svg>
            </div>

            @* Controls *@
            <div class="d-flex justify-content-center gap-3 mb-4">
                @if (!_isRunning)
                {
                    <button class="btn btn-success btn-lg" @onclick="StartTimer">
                        <span class="oi oi-media-play me-1"></span> Start
                    </button>
                }
                else
                {
                    <button class="btn btn-warning btn-lg" @onclick="PauseTimer">
                        <span class="oi oi-media-pause me-1"></span> Pause
                    </button>
                }
                <button class="btn btn-outline-secondary btn-lg" @onclick="ResetTimer">
                    <span class="oi oi-reload me-1"></span> Reset
                </button>
            </div>

            @* Session Settings *@
            <div class="mb-4">
                <div class="btn-group" role="group">
                    <button class="btn btn-sm @(_focusMinutes == 15 ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetDuration(15)" disabled="@_isRunning">15 min</button>
                    <button class="btn btn-sm @(_focusMinutes == 25 ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetDuration(25)" disabled="@_isRunning">25 min</button>
                    <button class="btn btn-sm @(_focusMinutes == 45 ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetDuration(45)" disabled="@_isRunning">45 min</button>
                    <button class="btn btn-sm @(_focusMinutes == 60 ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetDuration(60)" disabled="@_isRunning">60 min</button>
                </div>
            </div>

            @* Quick Actions *@
            <div class="d-flex justify-content-center gap-2">
                @if (_selectedTask.Title != "Free Focus")
                {
                    <button class="btn btn-outline-success btn-sm" @onclick="CompleteTask">
                        <span class="oi oi-check me-1"></span> Mark Complete
                    </button>
                }
                <button class="btn btn-outline-secondary btn-sm" @onclick="ChangeTask">
                    <span class="oi oi-arrow-left me-1"></span> Change Task
                </button>
            </div>

            @* Sessions completed today *@
            @if (_sessionsToday > 0)
            {
                <div class="mt-4 text-muted">
                    <small>
                        <span class="oi oi-star me-1"></span>
                        @_sessionsToday focus session@(_sessionsToday == 1 ? "" : "s") today
                    </small>
                </div>
            }
        </div>
    }
</div>

<CelebrationEffect @ref="_celebrationEffect" />

@code {
    private List<TodoTask> _availableTasks = new();
    private TodoTask? _selectedTask;
    private bool _isRunning;
    private bool _isBreak;
    private int _focusMinutes = 25;
    private int _breakMinutes = 5;
    private int _remainingSeconds;
    private int _totalSeconds;
    private int _sessionsToday;
    private System.Threading.Timer? _timer;
    private CelebrationEffect? _celebrationEffect;
    private bool _enableCelebrations = true;

    protected override async Task OnInitializedAsync()
    {
        _availableTasks = (await TaskService.GetNextActionsAsync()).ToList();
        _remainingSeconds = _focusMinutes * 60;
        _totalSeconds = _remainingSeconds;

        var prefs = (await PreferencesRepository.GetAllAsync()).FirstOrDefault();
        if (prefs != null)
        {
            _enableCelebrations = prefs.EnableCelebrationEffects;
        }
    }

    private void SelectTask(TodoTask task)
    {
        _selectedTask = task;
        if (task.EstimatedMinutes > 0 && task.EstimatedMinutes <= 60)
        {
            SetDuration(task.EstimatedMinutes);
        }
    }

    private void StartFreeSession()
    {
        _selectedTask = new TodoTask { Title = "Free Focus" };
    }

    private void SetDuration(int minutes)
    {
        _focusMinutes = minutes;
        _remainingSeconds = minutes * 60;
        _totalSeconds = _remainingSeconds;
    }

    private void StartTimer()
    {
        _isRunning = true;
        _timer = new System.Threading.Timer(TimerTick, null, 1000, 1000);
    }

    private void PauseTimer()
    {
        _isRunning = false;
        _timer?.Dispose();
        _timer = null;
    }

    private void ResetTimer()
    {
        PauseTimer();
        _isBreak = false;
        _remainingSeconds = _focusMinutes * 60;
        _totalSeconds = _remainingSeconds;
    }

    private async void TimerTick(object? state)
    {
        _remainingSeconds--;

        if (_remainingSeconds <= 0)
        {
            _timer?.Dispose();
            _timer = null;
            _isRunning = false;

            if (!_isBreak)
            {
                // Focus session complete!
                _sessionsToday++;
                await InvokeAsync(async () =>
                {
                    if (_enableCelebrations && _celebrationEffect != null)
                    {
                        _ = _celebrationEffect.ShowAsync("Focus session complete!");
                    }
                    await PlayNotificationSound();
                    StateHasChanged();
                });

                // Switch to break
                _isBreak = true;
                _remainingSeconds = _breakMinutes * 60;
                _totalSeconds = _remainingSeconds;
            }
            else
            {
                // Break complete - ready for next session
                _isBreak = false;
                _remainingSeconds = _focusMinutes * 60;
                _totalSeconds = _remainingSeconds;
                await InvokeAsync(async () =>
                {
                    await PlayNotificationSound();
                    StateHasChanged();
                });
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task PlayNotificationSound()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", "new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' + 'BAAAA=').play().catch(() => {})");
        }
        catch
        {
            // Ignore audio errors
        }
    }

    private async Task CompleteTask()
    {
        if (_selectedTask != null && _selectedTask.Title != "Free Focus")
        {
            if (_selectedTask.IsRecurring)
            {
                await TaskService.CompleteRecurringTaskAsync(_selectedTask.Id);
            }
            else
            {
                await TaskService.CompleteAsync(_selectedTask.Id);
            }

            if (_enableCelebrations && _celebrationEffect != null)
            {
                _ = _celebrationEffect.ShowAsync($"Completed: {_selectedTask.Title}");
            }

            DataChangeNotification.NotifyDataChanged();
            _availableTasks = (await TaskService.GetNextActionsAsync()).ToList();
            ChangeTask();
        }
    }

    private void ChangeTask()
    {
        PauseTimer();
        _selectedTask = null;
        _isBreak = false;
        _remainingSeconds = _focusMinutes * 60;
        _totalSeconds = _remainingSeconds;
    }

    private static string FormatTime(int totalSeconds)
    {
        var minutes = totalSeconds / 60;
        var seconds = totalSeconds % 60;
        return $"{minutes:D2}:{seconds:D2}";
    }

    private double GetProgressOffset()
    {
        var circumference = 2 * Math.PI * 54;
        var progress = (double)_remainingSeconds / _totalSeconds;
        return circumference * (1 - progress);
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
