@page "/focus"
@page "/focus/{TaskId:guid}"
@using SelfOrganizer.Core.Models
@using SelfOrganizer.App.Services
@using SelfOrganizer.App.Components.Shared
@inject IFocusTimerState FocusTimerService
@inject SelfOrganizer.Core.Interfaces.ITaskService TaskService
@inject SelfOrganizer.Core.Interfaces.IRepository<UserPreferences> PreferencesRepository
@inject IDataChangeNotificationService DataChangeNotification
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IDisposable

<div class="focus-container">
    @if (_state.TaskTitle == null)
    {
        <div class="text-center py-5">
            <h2 class="mb-4">
                <span class="oi oi-clock me-2"></span>Focus Timer
            </h2>
            <p class="text-muted mb-4">Select a task to focus on, or start a free focus session.</p>

            @if (_availableTasks.Any())
            {
                <div class="mb-4">
                    <h5 class="mb-3">Pick a task:</h5>
                    <div class="list-group" style="max-width: 500px; margin: 0 auto;">
                        @foreach (var task in _availableTasks.Take(5))
                        {
                            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    @onclick="() => SelectTask(task)">
                                <span>@task.Title</span>
                                @if (task.EstimatedMinutes > 0)
                                {
                                    <span class="badge bg-secondary">@task.EstimatedMinutes min</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            }

            <button class="btn btn-lg btn-outline-primary" @onclick="StartFreeSession">
                <span class="oi oi-media-play me-2"></span>Start Free Focus Session
            </button>
        </div>
    }
    else
    {
        <div class="text-center">
            @* Current Task *@
            <div class="mb-4">
                <span class="badge @(_state.IsBreak ? "bg-success" : "bg-primary") fs-6 px-3 py-2">
                    @(_state.IsBreak ? "Break Time" : _state.TaskTitle)
                </span>
            </div>

            @* Timer Display *@
            <div class="timer-display mb-4">
                <div class="timer-digits @(_state.IsBreak ? "text-success" : "")">
                    @FormatTime(_state.RemainingSeconds)
                </div>
                <div class="timer-label text-muted">
                    @if (_state.IsBreak)
                    {
                        <span class="text-success">Break Time!</span>
                    }
                    else if (_state.IsRunning)
                    {
                        <span>Focus...</span>
                    }
                    else if (_state.RemainingSeconds == _state.FocusMinutes * 60)
                    {
                        <span>Ready to start</span>
                    }
                    else
                    {
                        <span>Paused</span>
                    }
                </div>
            </div>

            @* Progress Ring *@
            <div class="progress-container mb-4">
                <svg class="progress-ring" viewBox="0 0 120 120">
                    <circle class="progress-ring-bg" cx="60" cy="60" r="54" />
                    <circle class="progress-ring-fill @(_state.IsBreak ? "break" : "")"
                            cx="60" cy="60" r="54"
                            stroke-dasharray="@(2 * Math.PI * 54)"
                            stroke-dashoffset="@GetProgressOffset()" />
                </svg>
            </div>

            @* Controls *@
            <div class="d-flex justify-content-center gap-3 mb-4">
                @if (!_state.IsRunning)
                {
                    <button class="btn btn-success btn-lg" @onclick="StartTimer">
                        <span class="oi oi-media-play me-1"></span> Start
                    </button>
                }
                else
                {
                    <button class="btn btn-warning btn-lg" @onclick="PauseTimer">
                        <span class="oi oi-media-pause me-1"></span> Pause
                    </button>
                }
                <button class="btn btn-outline-secondary btn-lg" @onclick="ResetTimer">
                    <span class="oi oi-reload me-1"></span> Reset
                </button>
                <button class="btn btn-outline-info btn-lg" @onclick="OpenMiniWindow" title="Open mini window">
                    <span class="oi oi-external-link me-1"></span> Mini
                </button>
            </div>

            @* Session Settings *@
            <div class="mb-4">
                <div class="btn-group" role="group">
                    <button class="btn btn-sm @(_state.FocusMinutes == 15 ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetDuration(15)" disabled="@_state.IsRunning">15 min</button>
                    <button class="btn btn-sm @(_state.FocusMinutes == 25 ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetDuration(25)" disabled="@_state.IsRunning">25 min</button>
                    <button class="btn btn-sm @(_state.FocusMinutes == 45 ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetDuration(45)" disabled="@_state.IsRunning">45 min</button>
                    <button class="btn btn-sm @(_state.FocusMinutes == 60 ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetDuration(60)" disabled="@_state.IsRunning">60 min</button>
                </div>
            </div>

            @* Quick Actions *@
            <div class="d-flex justify-content-center gap-2">
                @if (_state.TaskId.HasValue)
                {
                    <button class="btn btn-outline-success btn-sm" @onclick="CompleteTask">
                        <span class="oi oi-check me-1"></span> Mark Complete
                    </button>
                }
                <button class="btn btn-outline-secondary btn-sm" @onclick="ChangeTask">
                    <span class="oi oi-arrow-left me-1"></span> Change Task
                </button>
            </div>

            @* Sessions completed today *@
            @if (_state.SessionsCompleted > 0)
            {
                <div class="mt-4 text-muted">
                    <small>
                        <span class="oi oi-star me-1"></span>
                        @_state.SessionsCompleted focus session@(_state.SessionsCompleted == 1 ? "" : "s") today
                    </small>
                </div>
            }
        </div>
    }
</div>

<CelebrationEffect @ref="_celebrationEffect" />

<style>
    .focus-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .timer-display {
        margin-bottom: 2rem;
    }

    .timer-digits {
        font-size: 4rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        line-height: 1;
        color: var(--text-primary);
    }

    .timer-label {
        font-size: 1rem;
        margin-top: 0.5rem;
    }

    .progress-container {
        display: flex;
        justify-content: center;
    }

    .progress-ring {
        width: 180px;
        height: 180px;
        transform: rotate(-90deg);
    }

    .progress-ring-bg {
        fill: none;
        stroke: var(--border-default, #e5e7eb);
        stroke-width: 8;
    }

    .progress-ring-fill {
        fill: none;
        stroke: var(--color-primary, #6366f1);
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
    }

    .progress-ring-fill.break {
        stroke: var(--color-success, #22c55e);
    }
</style>

@code {
    [Parameter] public Guid? TaskId { get; set; }

    private FocusTimerStateData _state = new();
    private List<TodoTask> _availableTasks = new();
    private CelebrationEffect? _celebrationEffect;
    private bool _enableCelebrations = true;

    protected override async Task OnInitializedAsync()
    {
        await FocusTimerService.InitializeAsync();
        _state = FocusTimerService.State;
        FocusTimerService.OnStateChanged += OnTimerStateChanged;

        _availableTasks = (await TaskService.GetNextActionsAsync()).ToList();

        var prefs = (await PreferencesRepository.GetAllAsync()).FirstOrDefault();
        if (prefs != null)
        {
            _enableCelebrations = prefs.EnableCelebrationEffects;
        }

        // If a task ID was passed via route parameter, start focus on that task
        if (TaskId.HasValue)
        {
            var task = _availableTasks.FirstOrDefault(t => t.Id == TaskId.Value);
            if (task != null)
            {
                await FocusTimerService.StartFocusAsync(task);
            }
        }
    }

    private void OnTimerStateChanged()
    {
        _state = FocusTimerService.State;
        InvokeAsync(StateHasChanged);
    }

    private async Task SelectTask(TodoTask task)
    {
        await FocusTimerService.StartFocusAsync(task);
    }

    private async Task StartFreeSession()
    {
        await FocusTimerService.StartFreeFocusAsync();
    }

    private async Task SetDuration(int minutes)
    {
        await FocusTimerService.SetDurationAsync(minutes);
    }

    private async Task StartTimer()
    {
        await FocusTimerService.PlayAsync();
    }

    private async Task PauseTimer()
    {
        await FocusTimerService.PauseAsync();
    }

    private async Task ResetTimer()
    {
        await FocusTimerService.ResetAsync();
    }

    private async Task OpenMiniWindow()
    {
        await FocusTimerService.OpenMiniWindowAsync();
    }

    private async Task CompleteTask()
    {
        if (_state.TaskId.HasValue)
        {
            var task = _availableTasks.FirstOrDefault(t => t.Id == _state.TaskId);
            if (task != null)
            {
                if (task.IsRecurring)
                {
                    await TaskService.CompleteRecurringTaskAsync(task.Id);
                }
                else
                {
                    await TaskService.CompleteAsync(task.Id);
                }

                if (_enableCelebrations && _celebrationEffect != null)
                {
                    _ = _celebrationEffect.ShowAsync($"Completed: {task.Title}");
                }

                DataChangeNotification.NotifyDataChanged();
                _availableTasks = (await TaskService.GetNextActionsAsync()).ToList();
            }
            await FocusTimerService.ClearFocusAsync();
        }
    }

    private async Task ChangeTask()
    {
        await FocusTimerService.ClearFocusAsync();
    }

    private static string FormatTime(int totalSeconds)
    {
        var minutes = totalSeconds / 60;
        var seconds = totalSeconds % 60;
        return $"{minutes:D2}:{seconds:D2}";
    }

    private double GetProgressOffset()
    {
        var circumference = 2 * Math.PI * 54;
        var progress = _state.TotalSeconds > 0
            ? (double)_state.RemainingSeconds / _state.TotalSeconds
            : 1;
        return circumference * (1 - progress);
    }

    public void Dispose()
    {
        FocusTimerService.OnStateChanged -= OnTimerStateChanged;
    }
}
