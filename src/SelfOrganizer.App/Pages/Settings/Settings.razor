@page "/settings"
@using SelfOrganizer.Core.Models
@using SelfOrganizer.Core.Interfaces
@using SelfOrganizer.App.Services
@using SelfOrganizer.App.Services.Intelligence
@using SelfOrganizer.App.Components.Shared
@using SelfOrganizer.App.Components.Settings
@using Microsoft.JSInterop
@inject IRepository<UserPreferences> PreferencesRepository
@inject SelfOrganizer.App.Services.Data.IIndexedDbService DbService
@inject IExportService ExportService
@inject IImportService ImportService
@inject IContextService ContextService
@inject ILlmService LlmService
@inject IBalanceDimensionService BalanceDimensionService
@inject ISettingsExportService SettingsExportService
@inject IJSRuntime JSRuntime

<div class="settings-page">
    <div class="settings-header">
        <h2>Settings</h2>
        <p class="text-muted">Customize your experience</p>
    </div>

    @* Tab Navigation *@
    <div class="settings-tabs">
        <button class="tab-btn @(_activeTab == "general" ? "active" : "")" @onclick="@(() => SetTab("general"))">
            <span class="oi oi-home"></span>
            <span>General</span>
        </button>
        <button class="tab-btn @(_activeTab == "schedule" ? "active" : "")" @onclick="@(() => SetTab("schedule"))">
            <span class="oi oi-clock"></span>
            <span>Schedule</span>
        </button>
        <button class="tab-btn @(_activeTab == "focus" ? "active" : "")" @onclick="@(() => SetTab("focus"))">
            <span class="oi oi-target"></span>
            <span>Focus & Accessibility</span>
        </button>
        <button class="tab-btn @(_activeTab == "ai" ? "active" : "")" @onclick="@(() => SetTab("ai"))">
            <span class="oi oi-lightbulb"></span>
            <span>AI</span>
        </button>
        <button class="tab-btn @(_activeTab == "data" ? "active" : "")" @onclick="@(() => SetTab("data"))">
            <span class="oi oi-hard-drive"></span>
            <span>Data</span>
        </button>
    </div>

    <div class="settings-content">
        @* ==================== GENERAL TAB ==================== *@
        @if (_activeTab == "general")
        {
            <div class="settings-section animate-fade-in">
                <h3>App Mode</h3>
                <p class="section-description">Choose your focus. This affects which contexts and dimensions are available.</p>

                <div class="mode-cards">
                    <div class="mode-card @(_appMode == AppMode.Work ? "selected" : "")" @onclick="() => SelectMode(AppMode.Work)">
                        <span class="mode-icon oi oi-briefcase"></span>
                        <div class="mode-info">
                            <strong>Work</strong>
                            <span>Career-focused contexts</span>
                        </div>
                        @if (_appMode == AppMode.Work)
                        {
                            <span class="oi oi-check mode-check"></span>
                        }
                    </div>
                    <div class="mode-card @(_appMode == AppMode.Life ? "selected" : "")" @onclick="() => SelectMode(AppMode.Life)">
                        <span class="mode-icon oi oi-heart"></span>
                        <div class="mode-info">
                            <strong>Life</strong>
                            <span>Personal & home focus</span>
                        </div>
                        @if (_appMode == AppMode.Life)
                        {
                            <span class="oi oi-check mode-check"></span>
                        }
                    </div>
                    <div class="mode-card @(_appMode == AppMode.Balanced ? "selected" : "")" @onclick="() => SelectMode(AppMode.Balanced)">
                        <span class="mode-icon oi oi-dial"></span>
                        <div class="mode-info">
                            <strong>Balanced</strong>
                            <span>Work & life combined</span>
                        </div>
                        @if (_appMode == AppMode.Balanced)
                        {
                            <span class="oi oi-check mode-check"></span>
                        }
                    </div>
                </div>

                @if (_pendingModeChange.HasValue && _pendingModeChange != _appMode)
                {
                    <div class="mode-confirm">
                        <span>Switching modes will update your available contexts.</span>
                        <div class="mode-confirm-actions">
                            <button class="btn btn-ghost" @onclick="CancelModeChange">Cancel</button>
                            <button class="btn btn-primary" @onclick="ConfirmModeChange" disabled="@_isSwitchingMode">
                                @if (_isSwitchingMode)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                Confirm
                            </button>
                        </div>
                    </div>
                }
            </div>

            <div class="settings-section">
                <h3>Contexts</h3>
                <p class="section-description">Where or how you can do tasks (e.g., @@home, @@computer)</p>

                @if (_contexts != null)
                {
                    <div class="context-chips">
                        @foreach (var context in _contexts)
                        {
                            <div class="context-chip">
                                <span class="context-dot" style="background-color: @context.Color;"></span>
                                <span>@context.Name</span>
                                @if (!context.IsBuiltIn)
                                {
                                    <button class="chip-remove" @onclick="() => DeleteContext(context.Id)">
                                        <span class="oi oi-x"></span>
                                    </button>
                                }
                            </div>
                        }
                    </div>

                    <div class="add-context">
                        <input type="text" placeholder="Add new context..."
                               @bind="_newContextName" @bind:event="oninput"
                               @onkeydown="HandleNewContextKeyDown" />
                        <button class="btn btn-primary btn-sm" @onclick="AddNewContext"
                                disabled="@string.IsNullOrWhiteSpace(_newContextName)">
                            Add
                        </button>
                    </div>
                }
            </div>

            <div class="settings-section">
                <h3>Quick Start</h3>
                <p class="section-description">Apply preset configurations optimized for different needs</p>

                @if (_preferences != null)
                {
                    <QuickStartPresetsPanel
                        Preferences="@_preferences"
                        Accessibility="@_accessibilitySettings"
                        PreferencesChanged="@OnPreferencesChanged"
                        AccessibilityChanged="@OnAccessibilitySettingsChanged"
                        OnPresetApplied="@OnPresetApplied" />
                }
            </div>
        }

        @* ==================== SCHEDULE TAB ==================== *@
        @if (_activeTab == "schedule")
        {
            <div class="settings-section animate-fade-in">
                <h3>Work Hours</h3>
                <p class="section-description">When your work day typically starts and ends</p>

                <div class="settings-row">
                    <div class="setting-field">
                        <label>Start</label>
                        <input type="time" @bind="_workDayStart" />
                    </div>
                    <div class="setting-field">
                        <label>End</label>
                        <input type="time" @bind="_workDayEnd" />
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Task Defaults</h3>
                <p class="section-description">Default durations for new tasks and breaks</p>

                <div class="settings-grid">
                    <div class="setting-field">
                        <label>Default task duration</label>
                        <div class="input-with-unit">
                            <input type="number" @bind="_defaultTaskDuration" min="5" />
                            <span>min</span>
                        </div>
                    </div>
                    <div class="setting-field">
                        <label>Minimum block size</label>
                        <div class="input-with-unit">
                            <input type="number" @bind="_minimumBlockSize" min="5" />
                            <span>min</span>
                        </div>
                    </div>
                    <div class="setting-field">
                        <label>Deep work minimum</label>
                        <div class="input-with-unit">
                            <input type="number" @bind="_deepWorkMinimum" min="30" />
                            <span>min</span>
                        </div>
                    </div>
                    <div class="setting-field">
                        <label>Default break</label>
                        <div class="input-with-unit">
                            <input type="number" @bind="_defaultBreak" min="5" />
                            <span>min</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Meetings</h3>
                <p class="section-description">Buffer time and meeting limits</p>

                <div class="settings-row">
                    <div class="setting-field">
                        <label>Buffer between meetings</label>
                        <div class="input-with-unit">
                            <input type="number" @bind="_bufferBetweenMeetings" min="0" />
                            <span>min</span>
                        </div>
                    </div>
                    <div class="setting-field">
                        <label>Max consecutive meetings</label>
                        <div class="input-with-unit">
                            <input type="number" @bind="_maxConsecutiveMeetings" min="30" />
                            <span>min</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Reviews</h3>
                <p class="section-description">When to be reminded about daily and weekly reviews</p>

                <div class="settings-row">
                    <div class="setting-field">
                        <label>Daily review time</label>
                        <select @bind="_dailyReviewHour">
                            @for (int i = 0; i < 24; i++)
                            {
                                var hour = i == 0 ? 12 : (i > 12 ? i - 12 : i);
                                var ampm = i < 12 ? "AM" : "PM";
                                <option value="@i">@hour:00 @ampm</option>
                            }
                        </select>
                    </div>
                    <div class="setting-field">
                        <label>Weekly review day</label>
                        <select @bind="_weeklyReviewDay">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                </div>
            </div>
        }

        @* ==================== FOCUS & ACCESSIBILITY TAB ==================== *@
        @if (_activeTab == "focus")
        {
            <div class="settings-section animate-fade-in">
                <h3>Accessibility</h3>
                <p class="section-description">Vision, reading, motion, and interaction settings</p>

                <AccessibilitySettingsPanel
                    Settings="@_accessibilitySettings"
                    SettingsChanged="@OnAccessibilitySettingsChanged"
                    OnChanged="@MarkDirty" />
            </div>

            <div class="settings-section">
                <h3>ADHD & Neurodivergent Support</h3>
                <p class="section-description">Focus, time perception, and executive function accommodations</p>

                @if (_preferences != null)
                {
                    <NeurodivergentSettingsPanel
                        Preferences="@_preferences"
                        PreferencesChanged="@OnPreferencesChanged"
                        OnSettingsChanged="@MarkDirty" />
                }
            </div>
        }

        @* ==================== AI TAB ==================== *@
        @if (_activeTab == "ai")
        {
            <div class="settings-section animate-fade-in">
                <h3>AI Features</h3>
                <p class="section-description">Configure AI-powered suggestions and improvements</p>

                <div class="setting-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" @bind="_llmEnabled" />
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="toggle-label">
                        <strong>Enable AI Features</strong>
                        <span>Goal suggestions, task generation, and smart recommendations</span>
                    </div>
                </div>

                @if (_llmEnabled)
                {
                    <div class="ai-provider-section">
                        <label>AI Provider</label>
                        <div class="provider-options">
                            <label class="provider-option @(_llmProvider == LlmProvider.Ollama ? "selected" : "")">
                                <input type="radio" name="provider" checked="@(_llmProvider == LlmProvider.Ollama)"
                                       @onchange="() => _llmProvider = LlmProvider.Ollama" />
                                <div class="provider-info">
                                    <strong>Ollama</strong>
                                    <span>Local, free, private</span>
                                </div>
                            </label>
                            <label class="provider-option @(_llmProvider == LlmProvider.OpenAI ? "selected" : "")">
                                <input type="radio" name="provider" checked="@(_llmProvider == LlmProvider.OpenAI)"
                                       @onchange="() => _llmProvider = LlmProvider.OpenAI" />
                                <div class="provider-info">
                                    <strong>OpenAI</strong>
                                    <span>GPT-4, cloud-based</span>
                                </div>
                            </label>
                            <label class="provider-option @(_llmProvider == LlmProvider.Anthropic ? "selected" : "")">
                                <input type="radio" name="provider" checked="@(_llmProvider == LlmProvider.Anthropic)"
                                       @onchange="() => _llmProvider = LlmProvider.Anthropic" />
                                <div class="provider-info">
                                    <strong>Claude</strong>
                                    <span>Anthropic, cloud-based</span>
                                </div>
                            </label>
                        </div>

                        <div class="connection-status">
                            <div class="status-info">
                                @if (_llmConnectionStatus == null)
                                {
                                    <span class="status-dot neutral"></span>
                                    <span>Not tested</span>
                                }
                                else if (_llmConnectionStatus.IsConnected)
                                {
                                    <span class="status-dot connected"></span>
                                    <span>Connected @(!string.IsNullOrEmpty(_llmConnectionStatus.Model) ? $"({_llmConnectionStatus.Model})" : "")</span>
                                }
                                else
                                {
                                    <span class="status-dot error"></span>
                                    <span>@(_llmConnectionStatus.ErrorMessage ?? "Not connected")</span>
                                }
                            </div>
                            <button class="btn btn-ghost btn-sm" @onclick="TestLlmConnection" disabled="@_isTestingLlm">
                                @if (_isTestingLlm)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                else
                                {
                                    <span>Test</span>
                                }
                            </button>
                        </div>

                        <div class="config-note">
                            <span class="oi oi-info"></span>
                            <span>API keys are configured in <code>appsettings.Local.json</code> for security.</span>
                        </div>
                    </div>
                }
            </div>
        }

        @* ==================== DATA TAB ==================== *@
        @if (_activeTab == "data")
        {
            <div class="settings-section animate-fade-in">
                <h3>Export</h3>
                <p class="section-description">Backup your data or transfer to another device</p>

                <div class="data-actions">
                    <button class="data-action-btn" @onclick="ExportSettingsJson" disabled="@_isExportingSettings">
                        <span class="oi oi-cog"></span>
                        <div>
                            <strong>Export Settings</strong>
                            <span>Preferences and configuration</span>
                        </div>
                    </button>
                    <button class="data-action-btn" @onclick="ExportAllJson" disabled="@_isExporting">
                        <span class="oi oi-data-transfer-download"></span>
                        <div>
                            <strong>Export All Data</strong>
                            <span>Complete backup (JSON)</span>
                        </div>
                    </button>
                </div>

                @if (_exportResult != null || _settingsExportResult != null)
                {
                    var result = _exportResult ?? _settingsExportResult;
                    <div class="export-result @(result!.Success ? "success" : "error")">
                        <span class="oi @(result.Success ? "oi-check" : "oi-warning")"></span>
                        <span>@(result.Success ? $"Exported to {result.Filename}" : result.ErrorMessage)</span>
                    </div>
                }
            </div>

            <div class="settings-section">
                <h3>Import</h3>
                <p class="section-description">Restore from a backup file</p>

                <button class="data-action-btn" @onclick="() => _showImportModal = true">
                    <span class="oi oi-data-transfer-upload"></span>
                    <div>
                        <strong>Import Data</strong>
                        <span>Restore from JSON backup</span>
                    </div>
                </button>

                @if (_importResult != null)
                {
                    <div class="export-result @(_importResult.Success ? "success" : "error")">
                        <span class="oi @(_importResult.Success ? "oi-check" : "oi-warning")"></span>
                        <span>@_importResult.Message</span>
                    </div>
                }
            </div>

            <div class="settings-section danger-zone">
                <h3>Danger Zone</h3>
                <p class="section-description">Irreversible actions</p>

                <button class="btn btn-danger-outline" @onclick="() => _showClearConfirm = true">
                    <span class="oi oi-trash"></span>
                    Clear All Data
                </button>
            </div>

            <div class="settings-section">
                <h3>Advanced</h3>

                <a href="/settings/linking-rules" class="advanced-link">
                    <span class="oi oi-link-intact"></span>
                    <div>
                        <strong>Entity Linking Rules</strong>
                        <span>Auto-link calendar events to projects</span>
                    </div>
                    <span class="oi oi-chevron-right"></span>
                </a>
                <a href="/settings/calendar-providers" class="advanced-link">
                    <span class="oi oi-calendar"></span>
                    <div>
                        <strong>Calendar Providers</strong>
                        <span>Connect Google Calendar & others</span>
                    </div>
                    <span class="oi oi-chevron-right"></span>
                </a>
            </div>
        }

        @* Save Button - Fixed at bottom *@
        <div class="settings-footer">
            <button class="btn btn-primary btn-lg" @onclick="SaveSettings">
                <span class="oi oi-check"></span>
                Save Changes
            </button>
            @if (_saveSuccess)
            {
                <span class="save-success">Saved!</span>
            }
        </div>
    </div>
</div>

<ConfirmDialog
    Title="Clear All Data"
    Message="This will permanently delete all your tasks, projects, and settings. This action cannot be undone!"
    IsVisible="@_showClearConfirm"
    OnConfirm="ClearAllData"
    OnCancel="() => _showClearConfirm = false" />

<ImportModal
    IsVisible="@_showImportModal"
    OnClose="CloseImportModal"
    EntityName="Database"
    ShowTemplateDownload="false"
    OnImportRequested="HandleImportRequested" />

@code {
    private string _activeTab = "general";

    private void SetTab(string tab) => _activeTab = tab;

    private TimeOnly _workDayStart = new TimeOnly(9, 0);
    private TimeOnly _workDayEnd = new TimeOnly(17, 0);
    private int _defaultTaskDuration = 30;
    private int _minimumBlockSize = 15;
    private int _deepWorkMinimum = 60;
    private int _defaultBreak = 10;
    private int _bufferBetweenMeetings = 5;
    private int _maxConsecutiveMeetings = 180;
    private int _dailyReviewHour = 17;
    private int _weeklyReviewDay = 5;
    private bool _saveSuccess = false;
    private bool _showClearConfirm = false;
    private bool _showImportModal = false;
    private UserPreferences? _preferences;
    private bool _isDirty = false;

    // Export/Import state
    private bool _isExporting;
    private bool _isExportingSettings;
    private ExportResult? _exportResult;
    private ExportResult? _settingsExportResult;
    private ImportResultInfo? _importResult;

    private class ImportResultInfo
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }

    // App Mode
    private AppMode _appMode = AppMode.Balanced;
    private AppMode? _pendingModeChange;
    private bool _isSwitchingMode;

    // Accessibility settings
    private AccessibilitySettings _accessibilitySettings = new();

    // Context management
    private List<Context>? _contexts;
    private string _newContextName = string.Empty;

    // LLM Settings
    private bool _llmEnabled = true;
    private LlmProvider _llmProvider = LlmProvider.Ollama;
    private LlmConnectionStatus? _llmConnectionStatus;
    private LlmSettingsFromConfig? _configSettings;
    private bool _isTestingLlm;

    protected override async Task OnInitializedAsync()
    {
        _appMode = await BalanceDimensionService.GetCurrentModeAsync();

        var prefs = await PreferencesRepository.GetAllAsync();
        _preferences = prefs.FirstOrDefault();

        if (_preferences != null)
        {
            _workDayStart = TimeOnly.FromTimeSpan(_preferences.WorkDayStart);
            _workDayEnd = TimeOnly.FromTimeSpan(_preferences.WorkDayEnd);
            _defaultTaskDuration = _preferences.DefaultTaskDurationMinutes;
            _minimumBlockSize = _preferences.MinimumUsableBlockMinutes;
            _deepWorkMinimum = _preferences.DeepWorkMinimumMinutes;
            _defaultBreak = _preferences.DefaultBreakMinutes;
            _bufferBetweenMeetings = _preferences.BufferBetweenMeetingsMinutes;
            _maxConsecutiveMeetings = _preferences.MaxConsecutiveMeetingMinutes;
            _dailyReviewHour = _preferences.DailyReviewReminderHour;
            _weeklyReviewDay = _preferences.WeeklyReviewDay;
            _accessibilitySettings = _preferences.Accessibility ?? new AccessibilitySettings();
        }

        await ApplyAccessibilitySettings();
        await LoadContexts();
        await LoadLlmSettings();
    }

    private async Task ApplyAccessibilitySettings()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("accessibilityInterop.applyAccessibilitySettings", _accessibilitySettings);
        }
        catch { }
    }

    private void OnAccessibilitySettingsChanged(AccessibilitySettings settings)
    {
        _accessibilitySettings = settings;
        if (_preferences != null)
        {
            _preferences.Accessibility = settings;
        }
    }

    private void OnPreferencesChanged(UserPreferences preferences)
    {
        _preferences = preferences;
    }

    private void MarkDirty()
    {
        _isDirty = true;
    }

    private async Task OnPresetApplied()
    {
        await ApplyAccessibilitySettings();
        await SaveSettings();
    }

    private void SelectMode(AppMode mode)
    {
        if (mode != _appMode)
        {
            _pendingModeChange = mode;
        }
    }

    private void CancelModeChange()
    {
        _pendingModeChange = null;
    }

    private async Task ConfirmModeChange()
    {
        if (!_pendingModeChange.HasValue) return;

        _isSwitchingMode = true;
        StateHasChanged();

        try
        {
            await BalanceDimensionService.SetModeAsync(_pendingModeChange.Value, seedContexts: true);
            _appMode = _pendingModeChange.Value;
            _pendingModeChange = null;
            await LoadContexts();
        }
        finally
        {
            _isSwitchingMode = false;
        }
    }

    private async Task LoadLlmSettings()
    {
        var llmSettings = await LlmService.GetSettingsAsync();
        _llmEnabled = llmSettings.IsEnabled;
        _llmProvider = llmSettings.Provider;
        _configSettings = await LlmService.GetConfigSettingsAsync();
    }

    private async Task LoadContexts()
    {
        _contexts = (await ContextService.GetAllSortedByMruAsync()).ToList();
    }

    private async Task AddNewContext()
    {
        if (string.IsNullOrWhiteSpace(_newContextName)) return;

        try
        {
            await ContextService.CreateAsync(_newContextName.Trim().ToLowerInvariant());
            _newContextName = string.Empty;
            await LoadContexts();
        }
        catch (InvalidOperationException)
        {
            _newContextName = string.Empty;
        }
    }

    private async Task HandleNewContextKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddNewContext();
        }
    }

    private async Task DeleteContext(Guid contextId)
    {
        await ContextService.DeleteAsync(contextId);
        await LoadContexts();
    }

    private async Task SaveSettings()
    {
        _saveSuccess = false;

        if (_preferences == null)
        {
            _preferences = new UserPreferences();
        }

        _preferences.WorkDayStart = _workDayStart.ToTimeSpan();
        _preferences.WorkDayEnd = _workDayEnd.ToTimeSpan();
        _preferences.DefaultTaskDurationMinutes = _defaultTaskDuration;
        _preferences.MinimumUsableBlockMinutes = _minimumBlockSize;
        _preferences.DeepWorkMinimumMinutes = _deepWorkMinimum;
        _preferences.DefaultBreakMinutes = _defaultBreak;
        _preferences.BufferBetweenMeetingsMinutes = _bufferBetweenMeetings;
        _preferences.MaxConsecutiveMeetingMinutes = _maxConsecutiveMeetings;
        _preferences.DailyReviewReminderHour = _dailyReviewHour;
        _preferences.WeeklyReviewDay = _weeklyReviewDay;
        _preferences.Accessibility = _accessibilitySettings;

        await SaveLlmSettings();

        if (_preferences.CreatedAt == default)
        {
            await PreferencesRepository.AddAsync(_preferences);
        }
        else
        {
            await PreferencesRepository.UpdateAsync(_preferences);
        }

        _saveSuccess = true;
        _isDirty = false;

        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            _saveSuccess = false;
            await InvokeAsync(StateHasChanged);
        });
    }

    private async Task ExportSettingsJson()
    {
        _isExportingSettings = true;
        _settingsExportResult = null;
        _exportResult = null;
        StateHasChanged();

        try
        {
            _settingsExportResult = await SettingsExportService.ExportAndDownloadSettingsAsync();
        }
        catch (Exception ex)
        {
            _settingsExportResult = ExportResult.Failed($"Export failed: {ex.Message}");
        }
        finally
        {
            _isExportingSettings = false;
        }
    }

    private async Task ExportAllJson()
    {
        _isExporting = true;
        _exportResult = null;
        _settingsExportResult = null;
        StateHasChanged();

        try
        {
            var json = await DbService.ExportAllAsync();
            var filename = $"self-organizer-backup-{DateTime.Now:yyyy-MM-dd}.json";
            _exportResult = await ExportService.DownloadFileAsync(filename, json, "application/json");
        }
        catch (Exception ex)
        {
            _exportResult = ExportResult.Failed($"Export failed: {ex.Message}");
        }
        finally
        {
            _isExporting = false;
        }
    }

    private void CloseImportModal()
    {
        _showImportModal = false;
    }

    private async Task HandleImportRequested(ImportRequestEventArgs args)
    {
        if (args.IsValidationOnly)
        {
            args.ValidationResult = new ImportValidationResult { IsValid = true };
            return;
        }

        try
        {
            await DbService.ImportAllAsync(args.Content);
            args.Success = true;
            args.ImportedCount = 1;
            args.TotalCount = 1;
            args.ResultMessage = "Database imported successfully. Refresh to see changes.";

            _importResult = new ImportResultInfo
            {
                Success = true,
                Message = "Import successful! Refresh to see changes."
            };
        }
        catch (Exception ex)
        {
            args.Success = false;
            args.Errors.Add(new ImportError
            {
                RowNumber = 0,
                Message = $"Import failed: {ex.Message}"
            });
        }
    }

    private async Task ClearAllData()
    {
        await DbService.ClearAsync("captures");
        await DbService.ClearAsync("tasks");
        await DbService.ClearAsync("projects");
        await DbService.ClearAsync("events");
        await DbService.ClearAsync("timeBlocks");
        await DbService.ClearAsync("contacts");
        await DbService.ClearAsync("references");
        await DbService.ClearAsync("contexts");
        await DbService.ClearAsync("categories");
        await DbService.ClearAsync("preferences");
        await DbService.ClearAsync("dailySnapshots");
        await DbService.ClearAsync("goals");
        await DbService.ClearAsync("ideas");

        _showClearConfirm = false;
        _preferences = null;
    }

    private async Task SaveLlmSettings()
    {
        var llmSettings = new LlmSettings
        {
            IsEnabled = _llmEnabled,
            Provider = _llmProvider
        };
        await LlmService.SaveSettingsAsync(llmSettings);
    }

    private async Task TestLlmConnection()
    {
        _isTestingLlm = true;
        _llmConnectionStatus = null;
        StateHasChanged();

        try
        {
            await SaveLlmSettings();
            _llmConnectionStatus = await LlmService.GetConnectionStatusAsync();
        }
        catch (Exception ex)
        {
            _llmConnectionStatus = new LlmConnectionStatus
            {
                IsConnected = false,
                ErrorMessage = ex.Message
            };
        }
        finally
        {
            _isTestingLlm = false;
        }
    }
}
