@page "/settings"
@using SelfOrganizer.Core.Models
@using SelfOrganizer.Core.Interfaces
@using SelfOrganizer.App.Services
@using SelfOrganizer.App.Services.Intelligence
@using SelfOrganizer.App.Components.Shared
@inject IRepository<UserPreferences> PreferencesRepository
@inject SelfOrganizer.App.Services.Data.IIndexedDbService DbService
@inject IExportService ExportService
@inject IImportService ImportService
@inject IContextService ContextService
@inject ILlmService LlmService

<h3 class="mb-4">
    <span class="oi oi-cog me-2"></span>Settings
</h3>

<div class="row">
    <div class="col-lg-8">
        @* Work Schedule *@
        <div class="card mb-4">
            <div class="card-header">Work Schedule</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Work Day Start</label>
                        <input type="time" class="form-control" @bind="_workDayStart" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Work Day End</label>
                        <input type="time" class="form-control" @bind="_workDayEnd" />
                    </div>
                </div>
            </div>
        </div>

        @* Scheduling Preferences *@
        <div class="card mb-4">
            <div class="card-header">Scheduling Preferences</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Default Task Duration (min)</label>
                        <input type="number" class="form-control" @bind="_defaultTaskDuration" min="5" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Minimum Block Size (min)</label>
                        <input type="number" class="form-control" @bind="_minimumBlockSize" min="5" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Deep Work Minimum (min)</label>
                        <input type="number" class="form-control" @bind="_deepWorkMinimum" min="30" />
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Default Break (min)</label>
                        <input type="number" class="form-control" @bind="_defaultBreak" min="5" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Buffer Between Meetings (min)</label>
                        <input type="number" class="form-control" @bind="_bufferBetweenMeetings" min="0" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Consecutive Meetings (min)</label>
                        <input type="number" class="form-control" @bind="_maxConsecutiveMeetings" min="30" />
                    </div>
                </div>
            </div>
        </div>

        @* Review Settings *@
        <div class="card mb-4">
            <div class="card-header">Review Settings</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Daily Review Reminder Hour</label>
                        <select class="form-select" @bind="_dailyReviewHour">
                            @for (int i = 0; i < 24; i++)
                            {
                                var hour = i == 0 ? 12 : (i > 12 ? i - 12 : i);
                                var ampm = i < 12 ? "AM" : "PM";
                                <option value="@i">@hour:00 @ampm</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Weekly Review Day</label>
                        <select class="form-select" @bind="_weeklyReviewDay">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        @* ADHD & Focus Accommodations *@
        <div class="card mb-4">
            <div class="card-header">
                <span class="oi oi-target me-2"></span>ADHD & Focus Accommodations
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Features to help with decision fatigue and provide positive reinforcement during planning and task completion.
                </p>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="celebrationEffects" @bind="_enableCelebrationEffects" />
                        <label class="form-check-label" for="celebrationEffects">
                            <strong>Celebration Effects</strong>
                            <br /><small class="text-muted">Show confetti and animations when you complete tasks (dopamine hits!)</small>
                        </label>
                    </div>
                </div>

                <div class="mb-0">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="pickForMe" @bind="_enablePickForMe" />
                        <label class="form-check-label" for="pickForMe">
                            <strong>"Pick For Me" Button</strong>
                            <br /><small class="text-muted">Reduces decision fatigue by randomly selecting your next task from available options</small>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        @* Context Management *@
        <div class="card mb-4">
            <div class="card-header">
                <span class="oi oi-tag me-2"></span>Context Management
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Contexts define where or how you can do tasks (e.g., home, computer, errands). Built-in contexts cannot be deleted.
                </p>

                @if (_contexts == null)
                {
                    <div class="text-center py-2">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </div>
                }
                else
                {
                    <div class="context-list mb-3">
                        @foreach (var context in _contexts)
                        {
                            <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <span class="context-color-dot me-2" style="background-color: @context.Color; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span>
                                    <span>@context.Name</span>
                                    @if (context.IsBuiltIn)
                                    {
                                        <span class="badge bg-secondary ms-2" style="font-size: 0.7em;">Built-in</span>
                                    }
                                </div>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">Used @context.UsageCount times</small>
                                    @if (!context.IsBuiltIn)
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteContext(context.Id)"
                                                title="Delete context">
                                            <span class="oi oi-trash"></span>
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    @* Add new context *@
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="New context name..."
                               @bind="_newContextName" @bind:event="oninput"
                               @onkeydown="HandleNewContextKeyDown" />
                        <button class="btn btn-outline-success" @onclick="AddNewContext"
                                disabled="@string.IsNullOrWhiteSpace(_newContextName)">
                            <span class="oi oi-plus me-1"></span> Add
                        </button>
                    </div>
                }
            </div>
        </div>

        @* AI / LLM Configuration *@
        <div class="card mb-4">
            <div class="card-header">
                <span class="oi oi-lightbulb me-2"></span>AI / LLM Configuration
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Configure your AI provider for goal improvement, task generation, and other AI-powered features.
                </p>

                <div class="mb-3">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="llmEnabled" @bind="_llmEnabled" />
                        <label class="form-check-label" for="llmEnabled">
                            <strong>Enable AI Features</strong>
                        </label>
                    </div>
                </div>

                @if (_llmEnabled)
                {
                    <div class="mb-3">
                        <label class="form-label">AI Provider</label>
                        <select class="form-select" @bind="_llmProvider">
                            <option value="@LlmProvider.Ollama">Ollama (Local)</option>
                            <option value="@LlmProvider.OpenAI">OpenAI</option>
                            <option value="@LlmProvider.AzureOpenAI">Azure OpenAI</option>
                            <option value="@LlmProvider.Anthropic">Anthropic Claude</option>
                        </select>
                    </div>

                    @* Ollama Settings *@
                    @if (_llmProvider == LlmProvider.Ollama)
                    {
                        <div class="provider-settings border rounded p-3 bg-light">
                            <h6 class="mb-3">Ollama Settings</h6>
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Endpoint URL</label>
                                    <input type="text" class="form-control" @bind="_ollamaEndpoint" placeholder="http://localhost:11434" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Model</label>
                                    <input type="text" class="form-control" @bind="_ollamaModel" placeholder="llama3.2" />
                                </div>
                            </div>
                            <small class="text-muted">
                                <a href="https://ollama.ai" target="_blank">Ollama</a> runs locally and doesn't require an API key.
                            </small>
                        </div>
                    }

                    @* OpenAI Settings *@
                    @if (_llmProvider == LlmProvider.OpenAI)
                    {
                        <div class="provider-settings border rounded p-3 bg-light">
                            <h6 class="mb-3">OpenAI Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="password" class="form-control" @bind="_openAIApiKey" placeholder="sk-..." />
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Model</label>
                                    <select class="form-select" @bind="_openAIModel">
                                        <option value="gpt-4o">GPT-4o</option>
                                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                        <option value="gpt-4">GPT-4</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Endpoint (optional)</label>
                                    <input type="text" class="form-control" @bind="_openAIEndpoint" placeholder="https://api.openai.com/v1" />
                                </div>
                            </div>
                            <small class="text-muted">
                                Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>.
                            </small>
                        </div>
                    }

                    @* Azure OpenAI Settings *@
                    @if (_llmProvider == LlmProvider.AzureOpenAI)
                    {
                        <div class="provider-settings border rounded p-3 bg-light">
                            <h6 class="mb-3">Azure OpenAI Settings</h6>
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Azure OpenAI Endpoint</label>
                                    <input type="text" class="form-control" @bind="_azureEndpoint" placeholder="https://your-resource.openai.azure.com" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">API Version</label>
                                    <input type="text" class="form-control" @bind="_azureApiVersion" placeholder="2024-02-01" />
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Deployment Name</label>
                                <input type="text" class="form-control" @bind="_azureDeploymentName" placeholder="gpt-4" />
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="useAzureADAuth" @bind="_useAzureADAuth" />
                                    <label class="form-check-label" for="useAzureADAuth">
                                        Use Azure AD Authentication (instead of API Key)
                                    </label>
                                </div>
                            </div>

                            @if (!_useAzureADAuth)
                            {
                                <div class="mb-3">
                                    <label class="form-label">API Key</label>
                                    <input type="password" class="form-control" @bind="_azureApiKey" />
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning py-2">
                                    <small>Azure AD authentication fields are collected but not yet functional in browser context.</small>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Tenant ID</label>
                                        <input type="text" class="form-control" @bind="_azureTenantId" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Client ID</label>
                                        <input type="text" class="form-control" @bind="_azureClientId" />
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Client Secret</label>
                                        <input type="password" class="form-control" @bind="_azureClientSecret" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Scope</label>
                                        <input type="text" class="form-control" @bind="_azureScope" placeholder="https://cognitiveservices.azure.com/.default" />
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Anthropic Claude Settings *@
                    @if (_llmProvider == LlmProvider.Anthropic)
                    {
                        <div class="provider-settings border rounded p-3 bg-light">
                            <h6 class="mb-3">Anthropic Claude Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="password" class="form-control" @bind="_anthropicApiKey" placeholder="sk-ant-..." />
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Model</label>
                                    <select class="form-select" @bind="_anthropicModel">
                                        <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                                        <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
                                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Endpoint (optional)</label>
                                    <input type="text" class="form-control" @bind="_anthropicEndpoint" placeholder="https://api.anthropic.com" />
                                </div>
                            </div>
                            <small class="text-muted">
                                Get your API key from <a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic Console</a>.
                            </small>
                        </div>
                    }

                    <div class="mt-3">
                        <label class="form-label">Request Timeout (seconds)</label>
                        <input type="number" class="form-control" style="max-width: 150px;" @bind="_llmTimeoutSeconds" min="10" max="300" />
                    </div>

                    @* Connection Status *@
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <strong>Connection Status:</strong>
                                @if (_llmConnectionStatus == null)
                                {
                                    <span class="text-muted ms-2">Not tested</span>
                                }
                                else if (_llmConnectionStatus.IsConnected)
                                {
                                    <span class="text-success ms-2">
                                        <span class="oi oi-check me-1"></span>Connected
                                        @if (!string.IsNullOrEmpty(_llmConnectionStatus.Model))
                                        {
                                            <span class="text-muted">(@_llmConnectionStatus.Model)</span>
                                        }
                                    </span>
                                }
                                else
                                {
                                    <span class="text-danger ms-2">
                                        <span class="oi oi-x me-1"></span>@(_llmConnectionStatus.ErrorMessage ?? "Not connected")
                                    </span>
                                }
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="TestLlmConnection" disabled="@_isTestingLlm">
                                @if (_isTestingLlm)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                else
                                {
                                    <span class="oi oi-pulse me-1"></span>
                                }
                                Test Connection
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <button class="btn btn-primary btn-lg" @onclick="SaveSettings">
            <span class="oi oi-check me-1"></span> Save Settings
        </button>
        @if (_saveSuccess)
        {
            <span class="text-success ms-3">
                <span class="oi oi-check"></span> Saved!
            </span>
        }
    </div>

    <div class="col-lg-4">
        @* Data Management *@
        <div class="card mb-4">
            <div class="card-header">Data Management</div>
            <div class="card-body">
                <h6 class="mb-2">Export Data</h6>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-primary" @onclick="ExportAllJson" disabled="@_isExporting">
                        @if (_isExporting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        else
                        {
                            <span class="oi oi-data-transfer-download me-1"></span>
                        }
                        Export All (JSON)
                    </button>
                </div>

                @if (_exportResult != null)
                {
                    <div class="alert @(_exportResult.Success ? "alert-success" : "alert-danger") py-2 small mb-3">
                        @if (_exportResult.Success)
                        {
                            <span class="oi oi-check me-1"></span>
                            <span>Exported to @_exportResult.Filename</span>
                        }
                        else
                        {
                            <span class="oi oi-warning me-1"></span>
                            <span>@_exportResult.ErrorMessage</span>
                        }
                    </div>
                }

                <h6 class="mb-2">Import Data</h6>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-secondary" @onclick="() => _showImportModal = true">
                        <span class="oi oi-data-transfer-upload me-1"></span> Import Data (JSON)
                    </button>
                </div>

                @if (_importResult != null)
                {
                    <div class="alert @(_importResult.Success ? "alert-success" : "alert-danger") py-2 small mb-3">
                        @if (_importResult.Success)
                        {
                            <span class="oi oi-check me-1"></span>
                            <span>@_importResult.Message</span>
                        }
                        else
                        {
                            <span class="oi oi-warning me-1"></span>
                            <span>@_importResult.Message</span>
                        }
                    </div>
                }

                <hr />
                <h6 class="mb-2 text-danger">Danger Zone</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-danger" @onclick="() => _showClearConfirm = true">
                        <span class="oi oi-trash me-1"></span> Clear All Data
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">About</div>
            <div class="card-body">
                <p class="mb-1"><strong>Self Organizer</strong></p>
                <p class="text-muted small mb-0">GTD-inspired task management with smart scheduling.</p>
                <hr />
                <p class="small text-muted mb-0">Built with Blazor WebAssembly and .NET 9</p>
            </div>
        </div>
    </div>
</div>

<ConfirmDialog
    Title="Clear All Data"
    Message="This will permanently delete all your tasks, projects, and settings. This action cannot be undone!"
    IsVisible="@_showClearConfirm"
    OnConfirm="ClearAllData"
    OnCancel="() => _showClearConfirm = false" />

<ImportModal
    IsVisible="@_showImportModal"
    OnClose="CloseImportModal"
    EntityName="Database"
    ShowTemplateDownload="false"
    OnImportRequested="HandleImportRequested" />

@code {
    private TimeOnly _workDayStart = new TimeOnly(9, 0);
    private TimeOnly _workDayEnd = new TimeOnly(17, 0);
    private int _defaultTaskDuration = 30;
    private int _minimumBlockSize = 15;
    private int _deepWorkMinimum = 60;
    private int _defaultBreak = 10;
    private int _bufferBetweenMeetings = 5;
    private int _maxConsecutiveMeetings = 180;
    private int _dailyReviewHour = 17;
    private int _weeklyReviewDay = 5;
    private bool _saveSuccess = false;
    private bool _showClearConfirm = false;
    private bool _showImportModal = false;
    private UserPreferences? _preferences;

    // Export/Import state
    private bool _isExporting;
    private ExportResult? _exportResult;
    private ImportResultInfo? _importResult;

    private class ImportResultInfo
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }

    // ADHD Accommodation settings
    private bool _enableCelebrationEffects = true;
    private bool _enablePickForMe = true;

    // Context management
    private List<Context>? _contexts;
    private string _newContextName = string.Empty;

    // LLM Settings
    private bool _llmEnabled = true;
    private LlmProvider _llmProvider = LlmProvider.Ollama;
    private int _llmTimeoutSeconds = 60;
    private LlmConnectionStatus? _llmConnectionStatus;
    private bool _isTestingLlm;

    // Ollama
    private string _ollamaEndpoint = "http://localhost:11434";
    private string _ollamaModel = "llama3.2";

    // OpenAI
    private string _openAIApiKey = string.Empty;
    private string _openAIModel = "gpt-4o";
    private string _openAIEndpoint = "https://api.openai.com/v1";

    // Azure OpenAI
    private string _azureEndpoint = string.Empty;
    private string _azureDeploymentName = string.Empty;
    private string _azureApiVersion = "2024-02-01";
    private string _azureApiKey = string.Empty;
    private bool _useAzureADAuth = false;
    private string _azureTenantId = string.Empty;
    private string _azureClientId = string.Empty;
    private string _azureClientSecret = string.Empty;
    private string _azureScope = "https://cognitiveservices.azure.com/.default";

    // Anthropic
    private string _anthropicApiKey = string.Empty;
    private string _anthropicModel = "claude-3-5-sonnet-20241022";
    private string _anthropicEndpoint = "https://api.anthropic.com";

    protected override async Task OnInitializedAsync()
    {
        var prefs = await PreferencesRepository.GetAllAsync();
        _preferences = prefs.FirstOrDefault();

        if (_preferences != null)
        {
            // Work schedule
            _workDayStart = TimeOnly.FromTimeSpan(_preferences.WorkDayStart);
            _workDayEnd = TimeOnly.FromTimeSpan(_preferences.WorkDayEnd);
            _defaultTaskDuration = _preferences.DefaultTaskDurationMinutes;
            _minimumBlockSize = _preferences.MinimumUsableBlockMinutes;
            _deepWorkMinimum = _preferences.DeepWorkMinimumMinutes;
            _defaultBreak = _preferences.DefaultBreakMinutes;
            _bufferBetweenMeetings = _preferences.BufferBetweenMeetingsMinutes;
            _maxConsecutiveMeetings = _preferences.MaxConsecutiveMeetingMinutes;
            _dailyReviewHour = _preferences.DailyReviewReminderHour;
            _weeklyReviewDay = _preferences.WeeklyReviewDay;

            // ADHD accommodations
            _enableCelebrationEffects = _preferences.EnableCelebrationEffects;
            _enablePickForMe = _preferences.EnablePickForMe;
        }

        // Load contexts
        await LoadContexts();

        // Load LLM settings
        await LoadLlmSettings();
    }

    private async Task LoadLlmSettings()
    {
        var llmSettings = await LlmService.GetSettingsAsync();
        _llmEnabled = llmSettings.IsEnabled;
        _llmProvider = llmSettings.Provider;
        _llmTimeoutSeconds = llmSettings.TimeoutSeconds;

        // Ollama
        _ollamaEndpoint = llmSettings.OllamaEndpoint;
        _ollamaModel = llmSettings.OllamaModel;

        // OpenAI
        _openAIApiKey = llmSettings.OpenAIApiKey;
        _openAIModel = llmSettings.OpenAIModel;
        _openAIEndpoint = llmSettings.OpenAIEndpoint;

        // Azure OpenAI
        _azureEndpoint = llmSettings.AzureEndpoint;
        _azureDeploymentName = llmSettings.AzureDeploymentName;
        _azureApiVersion = llmSettings.AzureApiVersion;
        _azureApiKey = llmSettings.AzureApiKey;
        _useAzureADAuth = llmSettings.UseAzureADAuth;
        _azureTenantId = llmSettings.AzureTenantId;
        _azureClientId = llmSettings.AzureClientId;
        _azureClientSecret = llmSettings.AzureClientSecret;
        _azureScope = llmSettings.AzureScope;

        // Anthropic
        _anthropicApiKey = llmSettings.AnthropicApiKey;
        _anthropicModel = llmSettings.AnthropicModel;
        _anthropicEndpoint = llmSettings.AnthropicEndpoint;
    }

    private async Task LoadContexts()
    {
        _contexts = (await ContextService.GetAllSortedByMruAsync()).ToList();
    }

    private async Task AddNewContext()
    {
        if (string.IsNullOrWhiteSpace(_newContextName))
            return;

        try
        {
            await ContextService.CreateAsync(_newContextName.Trim().ToLowerInvariant());
            _newContextName = string.Empty;
            await LoadContexts();
        }
        catch (InvalidOperationException)
        {
            // Context already exists - just clear the input
            _newContextName = string.Empty;
        }
    }

    private async Task HandleNewContextKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddNewContext();
        }
    }

    private async Task DeleteContext(Guid contextId)
    {
        await ContextService.DeleteAsync(contextId);
        await LoadContexts();
    }

    private async Task SaveSettings()
    {
        _saveSuccess = false;

        if (_preferences == null)
        {
            _preferences = new UserPreferences();
        }

        // Work schedule
        _preferences.WorkDayStart = _workDayStart.ToTimeSpan();
        _preferences.WorkDayEnd = _workDayEnd.ToTimeSpan();
        _preferences.DefaultTaskDurationMinutes = _defaultTaskDuration;
        _preferences.MinimumUsableBlockMinutes = _minimumBlockSize;
        _preferences.DeepWorkMinimumMinutes = _deepWorkMinimum;
        _preferences.DefaultBreakMinutes = _defaultBreak;
        _preferences.BufferBetweenMeetingsMinutes = _bufferBetweenMeetings;
        _preferences.MaxConsecutiveMeetingMinutes = _maxConsecutiveMeetings;
        _preferences.DailyReviewReminderHour = _dailyReviewHour;
        _preferences.WeeklyReviewDay = _weeklyReviewDay;

        // ADHD accommodations
        _preferences.EnableCelebrationEffects = _enableCelebrationEffects;
        _preferences.EnablePickForMe = _enablePickForMe;

        // Save LLM settings
        await SaveLlmSettings();

        if (_preferences.CreatedAt == default)
        {
            await PreferencesRepository.AddAsync(_preferences);
        }
        else
        {
            await PreferencesRepository.UpdateAsync(_preferences);
        }

        _saveSuccess = true;
    }

    private async Task ExportAllJson()
    {
        _isExporting = true;
        _exportResult = null;
        StateHasChanged();

        try
        {
            var json = await DbService.ExportAllAsync();
            var filename = $"self-organizer-backup-{DateTime.Now:yyyy-MM-dd}.json";
            _exportResult = await ExportService.DownloadFileAsync(filename, json, "application/json");
        }
        catch (Exception ex)
        {
            _exportResult = ExportResult.Failed($"Export failed: {ex.Message}");
        }
        finally
        {
            _isExporting = false;
        }
    }

    private void CloseImportModal()
    {
        _showImportModal = false;
    }

    private async Task HandleImportRequested(ImportRequestEventArgs args)
    {
        if (args.IsValidationOnly)
        {
            // For JSON full database import, just mark as valid
            args.ValidationResult = new ImportValidationResult { IsValid = true };
            return;
        }

        try
        {
            // Import the full database
            await DbService.ImportAllAsync(args.Content);

            args.Success = true;
            args.ImportedCount = 1;
            args.TotalCount = 1;
            args.ResultMessage = "Database imported successfully. Please refresh the page to see updated data.";

            _importResult = new ImportResultInfo
            {
                Success = true,
                Message = "Import successful! Refresh to see changes."
            };
        }
        catch (Exception ex)
        {
            args.Success = false;
            args.Errors.Add(new ImportError
            {
                RowNumber = 0,
                Message = $"Import failed: {ex.Message}"
            });
        }
    }

    private async Task ClearAllData()
    {
        // Clear all stores
        await DbService.ClearAsync("captures");
        await DbService.ClearAsync("tasks");
        await DbService.ClearAsync("projects");
        await DbService.ClearAsync("events");
        await DbService.ClearAsync("timeBlocks");
        await DbService.ClearAsync("contacts");
        await DbService.ClearAsync("references");
        await DbService.ClearAsync("contexts");
        await DbService.ClearAsync("categories");
        await DbService.ClearAsync("preferences");
        await DbService.ClearAsync("dailySnapshots");

        _showClearConfirm = false;
        _preferences = null;
    }

    private async Task SaveLlmSettings()
    {
        var llmSettings = new LlmSettings
        {
            IsEnabled = _llmEnabled,
            Provider = _llmProvider,
            TimeoutSeconds = _llmTimeoutSeconds,

            // Ollama
            OllamaEndpoint = _ollamaEndpoint,
            OllamaModel = _ollamaModel,

            // OpenAI
            OpenAIApiKey = _openAIApiKey,
            OpenAIModel = _openAIModel,
            OpenAIEndpoint = _openAIEndpoint,

            // Azure OpenAI
            AzureEndpoint = _azureEndpoint,
            AzureDeploymentName = _azureDeploymentName,
            AzureApiVersion = _azureApiVersion,
            AzureApiKey = _azureApiKey,
            UseAzureADAuth = _useAzureADAuth,
            AzureTenantId = _azureTenantId,
            AzureClientId = _azureClientId,
            AzureClientSecret = _azureClientSecret,
            AzureScope = _azureScope,

            // Anthropic
            AnthropicApiKey = _anthropicApiKey,
            AnthropicModel = _anthropicModel,
            AnthropicEndpoint = _anthropicEndpoint
        };

        await LlmService.SaveSettingsAsync(llmSettings);
    }

    private async Task TestLlmConnection()
    {
        _isTestingLlm = true;
        _llmConnectionStatus = null;
        StateHasChanged();

        try
        {
            // Save current settings first so the test uses them
            await SaveLlmSettings();

            // Test the connection
            _llmConnectionStatus = await LlmService.GetConnectionStatusAsync();
        }
        catch (Exception ex)
        {
            _llmConnectionStatus = new LlmConnectionStatus
            {
                IsConnected = false,
                ErrorMessage = ex.Message
            };
        }
        finally
        {
            _isTestingLlm = false;
        }
    }
}
