@page "/settings"
@using SelfOrganizer.Core.Models
@using SelfOrganizer.Core.Interfaces
@using SelfOrganizer.App.Services
@using SelfOrganizer.App.Services.Intelligence
@using SelfOrganizer.App.Components.Shared
@using SelfOrganizer.App.Components.Settings
@using Microsoft.JSInterop
@inject IRepository<UserPreferences> PreferencesRepository
@inject SelfOrganizer.App.Services.Data.IIndexedDbService DbService
@inject IExportService ExportService
@inject IImportService ImportService
@inject IContextService ContextService
@inject ILlmService LlmService
@inject IBalanceDimensionService BalanceDimensionService
@inject ISettingsExportService SettingsExportService
@inject IJSRuntime JSRuntime

<h3 class="mb-4">
    <span class="oi oi-cog me-2"></span>Settings
</h3>

@* Quick Start Presets *@
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><span class="oi oi-bolt me-2"></span>Quick Start Presets</span>
        <button class="btn btn-sm btn-link p-0" @onclick="() => _presetsExpanded = !_presetsExpanded">
            <span class="oi @(_presetsExpanded ? "oi-chevron-top" : "oi-chevron-bottom")"></span>
        </button>
    </div>
    @if (_presetsExpanded)
    {
        <div class="card-body">
            @if (_preferences != null)
            {
                <QuickStartPresetsPanel
                    Preferences="@_preferences"
                    Accessibility="@_accessibilitySettings"
                    PreferencesChanged="@OnPreferencesChanged"
                    AccessibilityChanged="@OnAccessibilitySettingsChanged"
                    OnPresetApplied="@OnPresetApplied" />
            }
        </div>
    }
</div>

<div class="row">
    <div class="col-lg-8">
        @* App Mode *@
        <div class="card mb-4">
            <div class="card-header">
                <span class="oi oi-dial me-2"></span>App Mode
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Choose your focus mode. This affects which contexts and balance dimensions are available.
                </p>

                <div class="mode-selection mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="appMode" id="modeWork"
                               checked="@(_appMode == AppMode.Work)"
                               @onchange="() => SelectMode(AppMode.Work)" />
                        <label class="form-check-label" for="modeWork">
                            <strong><span class="oi oi-briefcase me-1"></span>Work Mode</strong>
                            <br /><small class="text-muted">Professional focus - career-oriented contexts and dimensions</small>
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="appMode" id="modeLife"
                               checked="@(_appMode == AppMode.Life)"
                               @onchange="() => SelectMode(AppMode.Life)" />
                        <label class="form-check-label" for="modeLife">
                            <strong><span class="oi oi-heart me-1"></span>Life Mode</strong>
                            <br /><small class="text-muted">Personal focus - home and life contexts and dimensions</small>
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="appMode" id="modeBalanced"
                               checked="@(_appMode == AppMode.Balanced)"
                               @onchange="() => SelectMode(AppMode.Balanced)" />
                        <label class="form-check-label" for="modeBalanced">
                            <strong><span class="oi oi-dial me-1"></span>Balanced Mode</strong>
                            <br /><small class="text-muted">Hybrid approach - curated mix of work and life dimensions</small>
                        </label>
                    </div>
                </div>

                @if (_pendingModeChange.HasValue && _pendingModeChange != _appMode)
                {
                    <div class="alert alert-warning py-2 mb-0">
                        <div class="d-flex align-items-center justify-content-between">
                            <span>
                                <span class="oi oi-warning me-1"></span>
                                Switching modes will update your available contexts.
                            </span>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" @onclick="CancelModeChange">Cancel</button>
                                <button class="btn btn-sm btn-warning" @onclick="ConfirmModeChange" disabled="@_isSwitchingMode">
                                    @if (_isSwitchingMode)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    Confirm
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Work Schedule *@
        <div class="card mb-4">
            <div class="card-header">Work Schedule</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Work Day Start</label>
                        <input type="time" class="form-control" @bind="_workDayStart" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Work Day End</label>
                        <input type="time" class="form-control" @bind="_workDayEnd" />
                    </div>
                </div>
            </div>
        </div>

        @* Scheduling Preferences *@
        <div class="card mb-4">
            <div class="card-header">Scheduling Preferences</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Default Task Duration (min)</label>
                        <input type="number" class="form-control" @bind="_defaultTaskDuration" min="5" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Minimum Block Size (min)</label>
                        <input type="number" class="form-control" @bind="_minimumBlockSize" min="5" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Deep Work Minimum (min)</label>
                        <input type="number" class="form-control" @bind="_deepWorkMinimum" min="30" />
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Default Break (min)</label>
                        <input type="number" class="form-control" @bind="_defaultBreak" min="5" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Buffer Between Meetings (min)</label>
                        <input type="number" class="form-control" @bind="_bufferBetweenMeetings" min="0" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Consecutive Meetings (min)</label>
                        <input type="number" class="form-control" @bind="_maxConsecutiveMeetings" min="30" />
                    </div>
                </div>
            </div>
        </div>

        @* Review Settings *@
        <div class="card mb-4">
            <div class="card-header">Review Settings</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Daily Review Reminder Hour</label>
                        <select class="form-select" @bind="_dailyReviewHour">
                            @for (int i = 0; i < 24; i++)
                            {
                                var hour = i == 0 ? 12 : (i > 12 ? i - 12 : i);
                                var ampm = i < 12 ? "AM" : "PM";
                                <option value="@i">@hour:00 @ampm</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Weekly Review Day</label>
                        <select class="form-select" @bind="_weeklyReviewDay">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        @* Accessibility Settings *@
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><span class="oi oi-contrast me-2"></span>Accessibility</span>
                <button class="btn btn-sm btn-link p-0" @onclick="() => _accessibilityExpanded = !_accessibilityExpanded">
                    <span class="oi @(_accessibilityExpanded ? "oi-chevron-top" : "oi-chevron-bottom")"></span>
                </button>
            </div>
            @if (_accessibilityExpanded)
            {
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Vision, reading, motion, and interaction settings for improved accessibility.
                    </p>
                    <AccessibilitySettingsPanel
                        Settings="@_accessibilitySettings"
                        SettingsChanged="@OnAccessibilitySettingsChanged"
                        OnChanged="@MarkDirty" />
                </div>
            }
        </div>

        @* ADHD & Neurodivergent Accommodations *@
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><span class="oi oi-target me-2"></span>ADHD & Neurodivergent Accommodations</span>
                <button class="btn btn-sm btn-link p-0" @onclick="() => _adhdExpanded = !_adhdExpanded">
                    <span class="oi @(_adhdExpanded ? "oi-chevron-top" : "oi-chevron-bottom")"></span>
                </button>
            </div>
            @if (_adhdExpanded)
            {
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Comprehensive settings for focus, time perception, motivation, and executive function support.
                    </p>
                    @if (_preferences != null)
                    {
                        <NeurodivergentSettingsPanel
                            Preferences="@_preferences"
                            PreferencesChanged="@OnPreferencesChanged"
                            OnSettingsChanged="@MarkDirty" />
                    }
                </div>
            }
        </div>

        @* Context Management *@
        <div class="card mb-4">
            <div class="card-header">
                <span class="oi oi-tag me-2"></span>Context Management
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Contexts define where or how you can do tasks (e.g., home, computer, errands). Built-in contexts cannot be deleted.
                </p>

                @if (_contexts == null)
                {
                    <div class="text-center py-2">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </div>
                }
                else
                {
                    <div class="context-list mb-3">
                        @foreach (var context in _contexts)
                        {
                            <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <span class="context-color-dot me-2" style="background-color: @context.Color; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span>
                                    <span>@context.Name</span>
                                    @if (context.IsBuiltIn)
                                    {
                                        <span class="badge bg-secondary ms-2" style="font-size: 0.7em;">Built-in</span>
                                    }
                                </div>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">Used @context.UsageCount times</small>
                                    @if (!context.IsBuiltIn)
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteContext(context.Id)"
                                                title="Delete context">
                                            <span class="oi oi-trash"></span>
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    @* Add new context *@
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="New context name..."
                               @bind="_newContextName" @bind:event="oninput"
                               @onkeydown="HandleNewContextKeyDown" />
                        <button class="btn btn-outline-success" @onclick="AddNewContext"
                                disabled="@string.IsNullOrWhiteSpace(_newContextName)">
                            <span class="oi oi-plus me-1"></span> Add
                        </button>
                    </div>
                }
            </div>
        </div>

        @* AI / LLM Configuration *@
        <div class="card mb-4">
            <div class="card-header">
                <span class="oi oi-lightbulb me-2"></span>AI / LLM Configuration
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Configure your AI provider for goal improvement, task generation, and other AI-powered features.
                    <strong>API keys are configured in <code>appsettings.Local.json</code></strong> for security.
                </p>

                <div class="mb-3">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="llmEnabled" @bind="_llmEnabled" />
                        <label class="form-check-label" for="llmEnabled">
                            <strong>Enable AI Features</strong>
                        </label>
                    </div>
                </div>

                @if (_llmEnabled)
                {
                    <div class="mb-3">
                        <label class="form-label">AI Provider</label>
                        <select class="form-select" @bind="_llmProvider">
                            <option value="@LlmProvider.Ollama">Ollama (Local)</option>
                            <option value="@LlmProvider.OpenAI">OpenAI</option>
                            <option value="@LlmProvider.AzureOpenAI">Azure OpenAI</option>
                            <option value="@LlmProvider.Anthropic">Anthropic Claude</option>
                        </select>
                    </div>

                    @* Ollama Settings *@
                    @if (_llmProvider == LlmProvider.Ollama)
                    {
                        <div class="provider-settings border rounded p-3 bg-light">
                            <h6 class="mb-3">Ollama Settings</h6>
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Endpoint URL</label>
                                    <div class="form-control-plaintext bg-white border rounded px-3 py-2">
                                        @(_configSettings?.OllamaEndpoint ?? "http://localhost:11434")
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Model</label>
                                    <div class="form-control-plaintext bg-white border rounded px-3 py-2">
                                        @(_configSettings?.OllamaModel ?? "llama3.2")
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">
                                <a href="https://ollama.ai" target="_blank">Ollama</a> runs locally and doesn't require an API key.
                                Configure in <code>appsettings.Local.json</code>.
                            </small>
                        </div>
                    }

                    @* OpenAI Settings *@
                    @if (_llmProvider == LlmProvider.OpenAI)
                    {
                        <div class="provider-settings border rounded p-3 bg-light">
                            <h6 class="mb-3">OpenAI Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">API Key Status</label>
                                <div class="d-flex align-items-center">
                                    @if (_configSettings?.HasOpenAIApiKey == true)
                                    {
                                        <span class="badge bg-success me-2"><span class="oi oi-check me-1"></span>Configured</span>
                                        <span class="text-muted small">API key loaded from appsettings</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark me-2"><span class="oi oi-warning me-1"></span>Not Configured</span>
                                        <span class="text-muted small">Add API key to appsettings.Local.json</span>
                                    }
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Model</label>
                                    <div class="form-control-plaintext bg-white border rounded px-3 py-2">
                                        @(_configSettings?.OpenAIModel ?? "gpt-4o")
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Endpoint</label>
                                    <div class="form-control-plaintext bg-white border rounded px-3 py-2 text-truncate" title="@(_configSettings?.OpenAIEndpoint)">
                                        @(_configSettings?.OpenAIEndpoint ?? "https://api.openai.com/v1")
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">
                                Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
                                and add it to <code>appsettings.Local.json</code>.
                            </small>
                        </div>
                    }

                    @* Azure OpenAI Settings *@
                    @if (_llmProvider == LlmProvider.AzureOpenAI)
                    {
                        <div class="provider-settings border rounded p-3 bg-light">
                            <h6 class="mb-3">Azure OpenAI Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">Authentication Status</label>
                                <div class="d-flex align-items-center">
                                    @if (_configSettings?.UseAzureAD == true)
                                    {
                                        @if (_configSettings?.HasAzureADConfig == true)
                                        {
                                            <span class="badge bg-success me-2"><span class="oi oi-check me-1"></span>Azure AD Configured</span>
                                            <span class="text-muted small">Using service principal authentication</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark me-2"><span class="oi oi-warning me-1"></span>Azure AD Not Configured</span>
                                            <span class="text-muted small">Add TenantId, ClientId, ClientSecret to appsettings</span>
                                        }
                                    }
                                    else if (_configSettings?.HasAzureApiKey == true)
                                    {
                                        <span class="badge bg-success me-2"><span class="oi oi-check me-1"></span>API Key Configured</span>
                                        <span class="text-muted small">Using API key authentication</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark me-2"><span class="oi oi-warning me-1"></span>Not Configured</span>
                                        <span class="text-muted small">Add API key or Azure AD credentials to appsettings</span>
                                    }
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Endpoint</label>
                                    <div class="form-control-plaintext bg-white border rounded px-3 py-2 text-truncate" title="@(_configSettings?.AzureEndpoint)">
                                        @(string.IsNullOrEmpty(_configSettings?.AzureEndpoint) ? "(not configured)" : _configSettings.AzureEndpoint)
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">API Version</label>
                                    <div class="form-control-plaintext bg-white border rounded px-3 py-2">
                                        @(_configSettings?.AzureApiVersion ?? "2024-02-01")
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Deployment Name</label>
                                <div class="form-control-plaintext bg-white border rounded px-3 py-2">
                                    @(string.IsNullOrEmpty(_configSettings?.AzureDeploymentName) ? "(not configured)" : _configSettings.AzureDeploymentName)
                                </div>
                            </div>
                            <small class="text-muted">
                                Configure your Azure OpenAI settings in <code>appsettings.Local.json</code>.
                                You can use either an API key or Azure AD service principal (TenantId, ClientId, ClientSecret).
                            </small>
                        </div>
                    }

                    @* Anthropic Claude Settings *@
                    @if (_llmProvider == LlmProvider.Anthropic)
                    {
                        <div class="provider-settings border rounded p-3 bg-light">
                            <h6 class="mb-3">Anthropic Claude Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">API Key Status</label>
                                <div class="d-flex align-items-center">
                                    @if (_configSettings?.HasAnthropicApiKey == true)
                                    {
                                        <span class="badge bg-success me-2"><span class="oi oi-check me-1"></span>Configured</span>
                                        <span class="text-muted small">API key loaded from appsettings</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark me-2"><span class="oi oi-warning me-1"></span>Not Configured</span>
                                        <span class="text-muted small">Add API key to appsettings.Local.json</span>
                                    }
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Model</label>
                                    <div class="form-control-plaintext bg-white border rounded px-3 py-2">
                                        @(_configSettings?.AnthropicModel ?? "claude-3-5-sonnet-20241022")
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Endpoint</label>
                                    <div class="form-control-plaintext bg-white border rounded px-3 py-2 text-truncate" title="@(_configSettings?.AnthropicEndpoint)">
                                        @(_configSettings?.AnthropicEndpoint ?? "https://api.anthropic.com")
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">
                                Get your API key from <a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic Console</a>
                                and add it to <code>appsettings.Local.json</code>.
                            </small>
                        </div>
                    }

                    <div class="mt-3">
                        <label class="form-label">Request Timeout</label>
                        <div class="form-control-plaintext bg-white border rounded px-3 py-2" style="max-width: 150px;">
                            @(_configSettings?.TimeoutSeconds ?? 60) seconds
                        </div>
                    </div>

                    @* Configuration Help *@
                    <div class="alert alert-info mt-3 py-2">
                        <small>
                            <strong>To configure API keys:</strong> Copy <code>src/SelfOrganizer.Server/appsettings.Development.json.template</code>
                            to <code>src/SelfOrganizer.Server/appsettings.Development.json</code> and fill in your credentials.
                            This file is git-ignored and won't be committed.
                        </small>
                    </div>

                    @* Connection Status *@
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <strong>Connection Status:</strong>
                                @if (_llmConnectionStatus == null)
                                {
                                    <span class="text-muted ms-2">Not tested</span>
                                }
                                else if (_llmConnectionStatus.IsConnected)
                                {
                                    <span class="text-success ms-2">
                                        <span class="oi oi-check me-1"></span>Connected
                                        @if (!string.IsNullOrEmpty(_llmConnectionStatus.Model))
                                        {
                                            <span class="text-muted">(@_llmConnectionStatus.Model)</span>
                                        }
                                    </span>
                                }
                                else
                                {
                                    <span class="text-danger ms-2">
                                        <span class="oi oi-x me-1"></span>@(_llmConnectionStatus.ErrorMessage ?? "Not connected")
                                    </span>
                                }
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="TestLlmConnection" disabled="@_isTestingLlm">
                                @if (_isTestingLlm)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                else
                                {
                                    <span class="oi oi-pulse me-1"></span>
                                }
                                Test Connection
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <button class="btn btn-primary btn-lg" @onclick="SaveSettings">
            <span class="oi oi-check me-1"></span> Save Settings
        </button>
        @if (_saveSuccess)
        {
            <span class="text-success ms-3">
                <span class="oi oi-check"></span> Saved!
            </span>
        }
    </div>

    <div class="col-lg-4">
        @* Data Management *@
        <div class="card mb-4">
            <div class="card-header">Data Management</div>
            <div class="card-body">
                <h6 class="mb-2">Export Settings</h6>
                <p class="text-muted small mb-2">
                    Export your settings to restore on another device or as a backup.
                </p>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-success" @onclick="ExportSettingsJson" disabled="@_isExportingSettings">
                        @if (_isExportingSettings)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        else
                        {
                            <span class="oi oi-cog me-1"></span>
                        }
                        Export Settings (JSON)
                    </button>
                </div>

                @if (_settingsExportResult != null)
                {
                    <div class="alert @(_settingsExportResult.Success ? "alert-success" : "alert-danger") py-2 small mb-3">
                        @if (_settingsExportResult.Success)
                        {
                            <span class="oi oi-check me-1"></span>
                            <span>Exported to @_settingsExportResult.Filename</span>
                        }
                        else
                        {
                            <span class="oi oi-warning me-1"></span>
                            <span>@_settingsExportResult.ErrorMessage</span>
                        }
                    </div>
                }

                <hr />

                <h6 class="mb-2">Export All Data</h6>
                <p class="text-muted small mb-2">
                    Export your entire database including tasks, projects, and settings.
                </p>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-primary" @onclick="ExportAllJson" disabled="@_isExporting">
                        @if (_isExporting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        else
                        {
                            <span class="oi oi-data-transfer-download me-1"></span>
                        }
                        Export All Data (JSON)
                    </button>
                </div>

                @if (_exportResult != null)
                {
                    <div class="alert @(_exportResult.Success ? "alert-success" : "alert-danger") py-2 small mb-3">
                        @if (_exportResult.Success)
                        {
                            <span class="oi oi-check me-1"></span>
                            <span>Exported to @_exportResult.Filename</span>
                        }
                        else
                        {
                            <span class="oi oi-warning me-1"></span>
                            <span>@_exportResult.ErrorMessage</span>
                        }
                    </div>
                }

                <h6 class="mb-2">Import Data</h6>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-secondary" @onclick="() => _showImportModal = true">
                        <span class="oi oi-data-transfer-upload me-1"></span> Import Data (JSON)
                    </button>
                </div>

                @if (_importResult != null)
                {
                    <div class="alert @(_importResult.Success ? "alert-success" : "alert-danger") py-2 small mb-3">
                        @if (_importResult.Success)
                        {
                            <span class="oi oi-check me-1"></span>
                            <span>@_importResult.Message</span>
                        }
                        else
                        {
                            <span class="oi oi-warning me-1"></span>
                            <span>@_importResult.Message</span>
                        }
                    </div>
                }

                <hr />
                <h6 class="mb-2 text-danger">Danger Zone</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-danger" @onclick="() => _showClearConfirm = true">
                        <span class="oi oi-trash me-1"></span> Clear All Data
                    </button>
                </div>
            </div>
        </div>

        @* Advanced Settings Links *@
        <div class="card mb-4">
            <div class="card-header">Advanced Settings</div>
            <div class="card-body">
                <a href="/settings/linking-rules" class="d-flex align-items-center text-decoration-none text-reset p-2 rounded hover-bg-light">
                    <span class="oi oi-link-intact me-3 text-primary" style="font-size: 1.2rem;"></span>
                    <div>
                        <div class="fw-bold">Entity Linking Rules</div>
                        <small class="text-muted">Auto-link calendar events to projects & goals</small>
                    </div>
                    <span class="oi oi-chevron-right ms-auto text-muted"></span>
                </a>
                <hr class="my-2" />
                <a href="/settings/calendar-providers" class="d-flex align-items-center text-decoration-none text-reset p-2 rounded hover-bg-light">
                    <span class="oi oi-calendar me-3 text-primary" style="font-size: 1.2rem;"></span>
                    <div>
                        <div class="fw-bold">Calendar Providers</div>
                        <small class="text-muted">Connect Google Calendar & other sources</small>
                    </div>
                    <span class="oi oi-chevron-right ms-auto text-muted"></span>
                </a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">About</div>
            <div class="card-body">
                <p class="mb-1"><strong>Self Organizer</strong> <span class="badge bg-primary">v2.0</span></p>
                <p class="text-muted small mb-2">GTD-inspired task management with smart scheduling, designed with comprehensive accessibility and neurodivergent accommodations.</p>
                <p class="text-muted small mb-0">
                    <span class="oi oi-contrast me-1"></span>Accessibility settings for vision, reading, and motor accommodations
                </p>
                <p class="text-muted small mb-0">
                    <span class="oi oi-target me-1"></span>ADHD, anxiety, autism, and depression-friendly presets
                </p>
                <hr />
                <p class="small text-muted mb-2">Built with Blazor WebAssembly and .NET 9</p>
                <a href="/release-notes" class="small">
                    <span class="oi oi-document me-1"></span>View Release Notes
                </a>
            </div>
        </div>
    </div>
</div>

<ConfirmDialog
    Title="Clear All Data"
    Message="This will permanently delete all your tasks, projects, and settings. This action cannot be undone!"
    IsVisible="@_showClearConfirm"
    OnConfirm="ClearAllData"
    OnCancel="() => _showClearConfirm = false" />

<ImportModal
    IsVisible="@_showImportModal"
    OnClose="CloseImportModal"
    EntityName="Database"
    ShowTemplateDownload="false"
    OnImportRequested="HandleImportRequested" />

@code {
    private TimeOnly _workDayStart = new TimeOnly(9, 0);
    private TimeOnly _workDayEnd = new TimeOnly(17, 0);
    private int _defaultTaskDuration = 30;
    private int _minimumBlockSize = 15;
    private int _deepWorkMinimum = 60;
    private int _defaultBreak = 10;
    private int _bufferBetweenMeetings = 5;
    private int _maxConsecutiveMeetings = 180;
    private int _dailyReviewHour = 17;
    private int _weeklyReviewDay = 5;
    private bool _saveSuccess = false;
    private bool _showClearConfirm = false;
    private bool _showImportModal = false;
    private UserPreferences? _preferences;
    private bool _isDirty = false;

    // Export/Import state
    private bool _isExporting;
    private bool _isExportingSettings;
    private ExportResult? _exportResult;
    private ExportResult? _settingsExportResult;
    private ImportResultInfo? _importResult;

    private class ImportResultInfo
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }

    // App Mode
    private AppMode _appMode = AppMode.Balanced;
    private AppMode? _pendingModeChange;
    private bool _isSwitchingMode;

    // Section expansion state
    private bool _presetsExpanded = true;
    private bool _accessibilityExpanded = false;
    private bool _adhdExpanded = false;

    // Accessibility settings
    private AccessibilitySettings _accessibilitySettings = new();

    // Context management
    private List<Context>? _contexts;
    private string _newContextName = string.Empty;

    // LLM Settings
    private bool _llmEnabled = true;
    private LlmProvider _llmProvider = LlmProvider.Ollama;
    private LlmConnectionStatus? _llmConnectionStatus;
    private LlmSettingsFromConfig? _configSettings;
    private bool _isTestingLlm;

    protected override async Task OnInitializedAsync()
    {
        // Load App Mode
        _appMode = await BalanceDimensionService.GetCurrentModeAsync();

        var prefs = await PreferencesRepository.GetAllAsync();
        _preferences = prefs.FirstOrDefault();

        if (_preferences != null)
        {
            // Work schedule
            _workDayStart = TimeOnly.FromTimeSpan(_preferences.WorkDayStart);
            _workDayEnd = TimeOnly.FromTimeSpan(_preferences.WorkDayEnd);
            _defaultTaskDuration = _preferences.DefaultTaskDurationMinutes;
            _minimumBlockSize = _preferences.MinimumUsableBlockMinutes;
            _deepWorkMinimum = _preferences.DeepWorkMinimumMinutes;
            _defaultBreak = _preferences.DefaultBreakMinutes;
            _bufferBetweenMeetings = _preferences.BufferBetweenMeetingsMinutes;
            _maxConsecutiveMeetings = _preferences.MaxConsecutiveMeetingMinutes;
            _dailyReviewHour = _preferences.DailyReviewReminderHour;
            _weeklyReviewDay = _preferences.WeeklyReviewDay;

            // Load accessibility settings
            _accessibilitySettings = _preferences.Accessibility ?? new AccessibilitySettings();
        }

        // Apply accessibility settings on load
        await ApplyAccessibilitySettings();

        // Load contexts
        await LoadContexts();

        // Load LLM settings
        await LoadLlmSettings();
    }

    private async Task ApplyAccessibilitySettings()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("accessibilityInterop.applyAccessibilitySettings", _accessibilitySettings);
        }
        catch
        {
            // Silently fail if JS interop not available yet
        }
    }

    private void OnAccessibilitySettingsChanged(AccessibilitySettings settings)
    {
        _accessibilitySettings = settings;
        if (_preferences != null)
        {
            _preferences.Accessibility = settings;
        }
    }

    private void OnPreferencesChanged(UserPreferences preferences)
    {
        _preferences = preferences;
    }

    private void MarkDirty()
    {
        _isDirty = true;
    }

    private async Task OnPresetApplied()
    {
        // Apply accessibility settings immediately
        await ApplyAccessibilitySettings();

        // Auto-save after preset is applied
        await SaveSettings();
    }

    private void SelectMode(AppMode mode)
    {
        if (mode != _appMode)
        {
            _pendingModeChange = mode;
        }
    }

    private void CancelModeChange()
    {
        _pendingModeChange = null;
    }

    private async Task ConfirmModeChange()
    {
        if (!_pendingModeChange.HasValue) return;

        _isSwitchingMode = true;
        StateHasChanged();

        try
        {
            await BalanceDimensionService.SetModeAsync(_pendingModeChange.Value, seedContexts: true);
            _appMode = _pendingModeChange.Value;
            _pendingModeChange = null;

            // Reload contexts to show updated list
            await LoadContexts();
        }
        finally
        {
            _isSwitchingMode = false;
        }
    }

    private async Task LoadLlmSettings()
    {
        // Load user preferences (provider selection, enabled state)
        var llmSettings = await LlmService.GetSettingsAsync();
        _llmEnabled = llmSettings.IsEnabled;
        _llmProvider = llmSettings.Provider;

        // Load config settings from server (API keys, endpoints from appsettings.json)
        _configSettings = await LlmService.GetConfigSettingsAsync();
    }

    private async Task LoadContexts()
    {
        _contexts = (await ContextService.GetAllSortedByMruAsync()).ToList();
    }

    private async Task AddNewContext()
    {
        if (string.IsNullOrWhiteSpace(_newContextName))
            return;

        try
        {
            await ContextService.CreateAsync(_newContextName.Trim().ToLowerInvariant());
            _newContextName = string.Empty;
            await LoadContexts();
        }
        catch (InvalidOperationException)
        {
            // Context already exists - just clear the input
            _newContextName = string.Empty;
        }
    }

    private async Task HandleNewContextKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddNewContext();
        }
    }

    private async Task DeleteContext(Guid contextId)
    {
        await ContextService.DeleteAsync(contextId);
        await LoadContexts();
    }

    private async Task SaveSettings()
    {
        _saveSuccess = false;

        if (_preferences == null)
        {
            _preferences = new UserPreferences();
        }

        // Work schedule
        _preferences.WorkDayStart = _workDayStart.ToTimeSpan();
        _preferences.WorkDayEnd = _workDayEnd.ToTimeSpan();
        _preferences.DefaultTaskDurationMinutes = _defaultTaskDuration;
        _preferences.MinimumUsableBlockMinutes = _minimumBlockSize;
        _preferences.DeepWorkMinimumMinutes = _deepWorkMinimum;
        _preferences.DefaultBreakMinutes = _defaultBreak;
        _preferences.BufferBetweenMeetingsMinutes = _bufferBetweenMeetings;
        _preferences.MaxConsecutiveMeetingMinutes = _maxConsecutiveMeetings;
        _preferences.DailyReviewReminderHour = _dailyReviewHour;
        _preferences.WeeklyReviewDay = _weeklyReviewDay;

        // Accessibility settings
        _preferences.Accessibility = _accessibilitySettings;

        // Save LLM settings
        await SaveLlmSettings();

        if (_preferences.CreatedAt == default)
        {
            await PreferencesRepository.AddAsync(_preferences);
        }
        else
        {
            await PreferencesRepository.UpdateAsync(_preferences);
        }

        _saveSuccess = true;
        _isDirty = false;
    }

    private async Task ExportSettingsJson()
    {
        _isExportingSettings = true;
        _settingsExportResult = null;
        StateHasChanged();

        try
        {
            _settingsExportResult = await SettingsExportService.ExportAndDownloadSettingsAsync();
        }
        catch (Exception ex)
        {
            _settingsExportResult = ExportResult.Failed($"Export failed: {ex.Message}");
        }
        finally
        {
            _isExportingSettings = false;
        }
    }

    private async Task ExportAllJson()
    {
        _isExporting = true;
        _exportResult = null;
        StateHasChanged();

        try
        {
            var json = await DbService.ExportAllAsync();
            var filename = $"self-organizer-backup-{DateTime.Now:yyyy-MM-dd}.json";
            _exportResult = await ExportService.DownloadFileAsync(filename, json, "application/json");
        }
        catch (Exception ex)
        {
            _exportResult = ExportResult.Failed($"Export failed: {ex.Message}");
        }
        finally
        {
            _isExporting = false;
        }
    }

    private void CloseImportModal()
    {
        _showImportModal = false;
    }

    private async Task HandleImportRequested(ImportRequestEventArgs args)
    {
        if (args.IsValidationOnly)
        {
            // For JSON full database import, just mark as valid
            args.ValidationResult = new ImportValidationResult { IsValid = true };
            return;
        }

        try
        {
            // Import the full database
            await DbService.ImportAllAsync(args.Content);

            args.Success = true;
            args.ImportedCount = 1;
            args.TotalCount = 1;
            args.ResultMessage = "Database imported successfully. Please refresh the page to see updated data.";

            _importResult = new ImportResultInfo
            {
                Success = true,
                Message = "Import successful! Refresh to see changes."
            };
        }
        catch (Exception ex)
        {
            args.Success = false;
            args.Errors.Add(new ImportError
            {
                RowNumber = 0,
                Message = $"Import failed: {ex.Message}"
            });
        }
    }

    private async Task ClearAllData()
    {
        // Clear all stores
        await DbService.ClearAsync("captures");
        await DbService.ClearAsync("tasks");
        await DbService.ClearAsync("projects");
        await DbService.ClearAsync("events");
        await DbService.ClearAsync("timeBlocks");
        await DbService.ClearAsync("contacts");
        await DbService.ClearAsync("references");
        await DbService.ClearAsync("contexts");
        await DbService.ClearAsync("categories");
        await DbService.ClearAsync("preferences");
        await DbService.ClearAsync("dailySnapshots");
        await DbService.ClearAsync("goals");
        await DbService.ClearAsync("ideas");

        _showClearConfirm = false;
        _preferences = null;
    }

    private async Task SaveLlmSettings()
    {
        // Only save user preferences (provider selection, enabled state)
        // API keys and other settings come from appsettings.json
        var llmSettings = new LlmSettings
        {
            IsEnabled = _llmEnabled,
            Provider = _llmProvider
        };

        await LlmService.SaveSettingsAsync(llmSettings);
    }

    private async Task TestLlmConnection()
    {
        _isTestingLlm = true;
        _llmConnectionStatus = null;
        StateHasChanged();

        try
        {
            // Save current settings first so the test uses them
            await SaveLlmSettings();

            // Test the connection
            _llmConnectionStatus = await LlmService.GetConnectionStatusAsync();
        }
        catch (Exception ex)
        {
            _llmConnectionStatus = new LlmConnectionStatus
            {
                IsConnected = false,
                ErrorMessage = ex.Message
            };
        }
        finally
        {
            _isTestingLlm = false;
        }
    }
}
