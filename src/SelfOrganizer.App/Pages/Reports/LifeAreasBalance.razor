@page "/balance"
@using SelfOrganizer.Core.Models
@using SelfOrganizer.App.Services
@using SelfOrganizer.App.Components.Balance
@inject SelfOrganizer.Core.Interfaces.IBalanceDimensionService BalanceDimensionService
@inject SelfOrganizer.Core.Interfaces.ITaskService TaskService
@inject SelfOrganizer.Core.Interfaces.IProjectService ProjectService
@inject SelfOrganizer.Core.Interfaces.IGoalService GoalService
@inject SelfOrganizer.Core.Interfaces.IRepository<Goal> GoalRepository
@inject IDataChangeNotificationService DataChangeNotification
@inject NavigationManager Navigation

<div class="balance-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3>
                <span class="oi oi-dial me-2"></span>@GetPageTitle()
            </h3>
            <p class="text-muted mb-0">Check in on balance across key @GetModeLabel() areas</p>
        </div>
        <div class="d-flex align-items-center gap-3">
            @* Mode Selector *@
            <div class="mode-selector btn-group" role="group">
                <button type="button"
                        class="btn btn-sm @(_currentMode == AppMode.Work ? "btn-primary" : "btn-outline-secondary")"
                        @onclick="() => SwitchMode(AppMode.Work)">
                    <span class="oi oi-briefcase me-1"></span>Work
                </button>
                <button type="button"
                        class="btn btn-sm @(_currentMode == AppMode.Life ? "btn-primary" : "btn-outline-secondary")"
                        @onclick="() => SwitchMode(AppMode.Life)">
                    <span class="oi oi-heart me-1"></span>Life
                </button>
                <button type="button"
                        class="btn btn-sm @(_currentMode == AppMode.Balanced ? "btn-primary" : "btn-outline-secondary")"
                        @onclick="() => SwitchMode(AppMode.Balanced)">
                    <span class="oi oi-dial me-1"></span>Balanced
                </button>
            </div>
            <button class="btn btn-primary" @onclick="StartAssessment">
                <span class="oi oi-pencil me-1"></span>Update Assessment
            </button>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_showAssessment)
    {
        <div class="assessment-wizard">
            <div class="assessment-header">
                <h5>Rate Your Satisfaction</h5>
                <p class="text-muted">On a scale of 1-10, how satisfied are you in each area?</p>
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar"
                         style="width: @((_currentAreaIndex + 1) * 100 / _dimensions.Count)%"></div>
                </div>
            </div>

            @if (_currentAreaIndex < _dimensions.Count)
            {
                var dimension = _dimensions[_currentAreaIndex];
                <div class="assessment-area">
                    <div class="area-header">
                        <span class="area-icon" style="background-color: @dimension.Color;">
                            <span class="oi @dimension.Icon"></span>
                        </span>
                        <div>
                            <h4>@dimension.Name</h4>
                            <p class="text-muted mb-0">@dimension.Description</p>
                        </div>
                    </div>

                    <div class="satisfaction-scale">
                        @for (int i = 1; i <= 10; i++)
                        {
                            var rating = i;
                            <button class="scale-btn @(_currentRatings.GetValueOrDefault(dimension.Id, 0) == rating ? "selected" : "")"
                                    style="@(_currentRatings.GetValueOrDefault(dimension.Id, 0) == rating ? $"background-color: {dimension.Color}; border-color: {dimension.Color};" : "")"
                                    @onclick="() => SetRating(dimension.Id, rating)">
                                @rating
                            </button>
                        }
                    </div>

                    <div class="scale-labels">
                        <span>Needs Work</span>
                        <span>Excellent</span>
                    </div>
                </div>
            }

            <div class="assessment-nav">
                @if (_currentAreaIndex > 0)
                {
                    <button class="btn btn-outline-secondary" @onclick="PreviousArea">
                        <span class="oi oi-arrow-left me-1"></span>Back
                    </button>
                }
                else
                {
                    <div></div>
                }

                @if (_currentAreaIndex < _dimensions.Count - 1)
                {
                    <button class="btn btn-primary" @onclick="NextArea"
                            disabled="@(_currentRatings.GetValueOrDefault(_dimensions[_currentAreaIndex].Id, 0) == 0)">
                        Next<span class="oi oi-arrow-right ms-1"></span>
                    </button>
                }
                else
                {
                    <button class="btn btn-success" @onclick="CompleteAssessment"
                            disabled="@(_currentRatings.GetValueOrDefault(_dimensions[_currentAreaIndex].Id, 0) == 0)">
                        <span class="oi oi-check me-1"></span>Complete
                    </button>
                }
            </div>
        </div>
    }
    else
    {
        <div class="balance-dashboard">
            @* Collapsible Insights Panel at Top *@
            @{
                var lowestDimension = _dimensions.OrderBy(d => GetEffectiveRating(d.Id)).FirstOrDefault();
                var highestDimension = _dimensions.OrderByDescending(d => GetEffectiveRating(d.Id)).FirstOrDefault();
                var avgRating = GetOverallScore();
                var variance = CalculateVariance();
                var dimensionsWithoutGoals = _dimensions.Where(d =>
                    !_goalsByDimension.GetValueOrDefault(d.Id, new List<Goal>()).Any() &&
                    GetEffectiveRating(d.Id) < 6).ToList();
                var hasInsights = (lowestDimension != null && GetEffectiveRating(lowestDimension.Id) < 5) ||
                                  (highestDimension != null && GetEffectiveRating(highestDimension.Id) >= 8) ||
                                  variance > 4 || (variance < 2 && avgRating >= 6) ||
                                  dimensionsWithoutGoals.Any();
            }
            @if (hasInsights)
            {
                <div class="insights-panel mb-4">
                    <div class="insights-header" @onclick="ToggleInsights">
                        <div class="d-flex align-items-center">
                            <span class="oi oi-lightbulb me-2"></span>
                            <span class="fw-medium">Insights & Recommendations</span>
                            <span class="insight-count ms-2">@GetInsightCount()</span>
                        </div>
                        <span class="oi @(_showInsights ? "oi-chevron-top" : "oi-chevron-bottom")"></span>
                    </div>
                    @if (_showInsights)
                    {
                        <div class="insights-content">
                            @if (lowestDimension != null && GetEffectiveRating(lowestDimension.Id) < 5)
                            {
                                <div class="insight-item needs-attention">
                                    <div class="insight-icon">
                                        <span class="oi oi-target"></span>
                                    </div>
                                    <div class="insight-body">
                                        <div class="insight-title">@lowestDimension.Name needs attention</div>
                                        <div class="insight-text">Rated @GetEffectiveRating(lowestDimension.Id)/10. Consider setting goals in this area.</div>
                                    </div>
                                </div>
                            }

                            @if (highestDimension != null && GetEffectiveRating(highestDimension.Id) >= 8)
                            {
                                <div class="insight-item strength">
                                    <div class="insight-icon">
                                        <span class="oi oi-star"></span>
                                    </div>
                                    <div class="insight-body">
                                        <div class="insight-title">@highestDimension.Name is a strength</div>
                                        <div class="insight-text">Rated @GetEffectiveRating(highestDimension.Id)/10. Great job maintaining this area!</div>
                                    </div>
                                </div>
                            }

                            @if (variance > 4)
                            {
                                <div class="insight-item imbalance">
                                    <div class="insight-icon">
                                        <span class="oi oi-warning"></span>
                                    </div>
                                    <div class="insight-body">
                                        <div class="insight-title">High imbalance detected</div>
                                        <div class="insight-text">Consider focusing on neglected areas for better overall wellbeing.</div>
                                    </div>
                                </div>
                            }
                            else if (variance < 2 && avgRating >= 6)
                            {
                                <div class="insight-item balanced">
                                    <div class="insight-icon">
                                        <span class="oi oi-check"></span>
                                    </div>
                                    <div class="insight-body">
                                        <div class="insight-title">Good balance!</div>
                                        <div class="insight-text">Your @GetModeLabel().ToLower() areas are fairly well-distributed.</div>
                                    </div>
                                </div>
                            }

                            @if (dimensionsWithoutGoals.Any())
                            {
                                <div class="insight-item suggestion">
                                    <div class="insight-icon">
                                        <span class="oi oi-plus"></span>
                                    </div>
                                    <div class="insight-body">
                                        <div class="insight-title">Set goals for improvement</div>
                                        <div class="insight-text">Consider creating goals for: @string.Join(", ", dimensionsWithoutGoals.Take(3).Select(d => d.Name))</div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            @* AI Recommendations Panel *@
            <BalanceAiPanel
                Ratings="_ratings"
                Dimensions="_dimensions"
                ActiveGoals="_activeGoals"
                ActiveTasks="_activeTasks"
                CurrentMode="_currentMode"
                OnTasksCreated="HandleTasksCreated"
                OnGoalCreated="HandleGoalCreated" />

            <div class="row">
                <div class="col-lg-6 mb-4">
                    @* Balance Wheel *@
                    <div class="balance-wheel-card">
                        <h5 class="mb-3">Balance Wheel</h5>
                        <div class="wheel-container">
                            <svg class="balance-wheel" viewBox="-100 -100 400 400">
                                @* Background circles - centered at 100,100 *@
                                @for (int i = 1; i <= 10; i++)
                                {
                                    var radius = i * 10;
                                    <circle cx="100" cy="100" r="@radius"
                                            class="wheel-ring @(i == 5 || i == 10 ? "major" : "")" />
                                }

                                @* Axis lines *@
                                @for (int i = 0; i < _dimensions.Count; i++)
                                {
                                    var angle = (i * 360.0 / _dimensions.Count) - 90;
                                    var rad = angle * Math.PI / 180;
                                    var x2 = 100 + 100 * Math.Cos(rad);
                                    var y2 = 100 + 100 * Math.Sin(rad);
                                    <line x1="100" y1="100" x2="@x2" y2="@y2" class="wheel-axis" />
                                }

                                @* Filled area polygon *@
                                @{
                                    var points = new List<string>();
                                    for (int i = 0; i < _dimensions.Count; i++)
                                    {
                                        var dimension = _dimensions[i];
                                        var rating = GetEffectiveRating(dimension.Id);
                                        var angle = (i * 360.0 / _dimensions.Count) - 90;
                                        var rad = angle * Math.PI / 180;
                                        var r = rating * 10;
                                        var x = 100 + r * Math.Cos(rad);
                                        var y = 100 + r * Math.Sin(rad);
                                        points.Add($"{x:F1},{y:F1}");
                                    }
                                }
                                <polygon points="@string.Join(" ", points)" class="wheel-fill" />

                                @* Data points *@
                                @for (int i = 0; i < _dimensions.Count; i++)
                                {
                                    var dimension = _dimensions[i];
                                    var pointRating = GetEffectiveRating(dimension.Id);
                                    var angle = (i * 360.0 / _dimensions.Count) - 90;
                                    var rad = angle * Math.PI / 180;
                                    var r = pointRating * 10;
                                    var x = 100 + r * Math.Cos(rad);
                                    var y = 100 + r * Math.Sin(rad);
                                    <circle cx="@x" cy="@y" r="5"
                                            fill="@dimension.Color" class="wheel-point" />
                                }

                                @* Labels *@
                                @for (int i = 0; i < _dimensions.Count; i++)
                                {
                                    var dimension = _dimensions[i];
                                    var angle = (i * 360.0 / _dimensions.Count) - 90;
                                    var rad = angle * Math.PI / 180;
                                    var x = 100 + 115 * Math.Cos(rad);
                                    var y = 100 + 115 * Math.Sin(rad);
                                    var textAnchor = angle > -90 && angle < 90 ? "start" : "end";
                                    if (Math.Abs(angle + 90) < 5 || Math.Abs(angle - 90) < 5)
                                    {
                                        textAnchor = "middle";
                                    }
                                    @((MarkupString)$"<text x=\"{x:F1}\" y=\"{y:F1}\" class=\"wheel-label\" style=\"text-anchor: {textAnchor}; fill: var(--text-primary, #e5e7eb);\">{dimension.Name}</text>")
                                }
                            </svg>
                        </div>

                        <div class="overall-score">
                            <div class="score-value">@GetOverallScore().ToString("F1")</div>
                            <div class="score-label">Overall Balance</div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    @* Area Details *@
                    <div class="areas-detail">
                        <h5 class="mb-3">Dimension Breakdown</h5>
                        <div class="area-list">
                            @foreach (var dimension in _dimensions.OrderByDescending(d => GetEffectiveRating(d.Id)))
                            {
                                var rating = GetEffectiveRating(dimension.Id);
                                var goals = _goalsByDimension.GetValueOrDefault(dimension.Id, new List<Goal>());
                                var tasksCount = _tasksByDimension.GetValueOrDefault(dimension.Id, 0);
                                var isExpanded = _expandedDimension == dimension.Id;

                                <div class="area-detail-item @(isExpanded ? "expanded" : "")">
                                    <div class="area-detail-header" @onclick="() => ToggleDimension(dimension.Id)" style="cursor: pointer;">
                                        <span class="area-icon-sm" style="background-color: @dimension.Color;">
                                            <span class="oi @dimension.Icon"></span>
                                        </span>
                                        <span class="area-name">@dimension.Name</span>
                                        <span class="area-rating" style="color: @GetRatingColor(rating);">@rating/10</span>
                                        @{
                                            var dimTasks = _taskListByDimension.GetValueOrDefault(dimension.Id, new List<TodoTask>());
                                            var dimProjects = _projectsByDimension.GetValueOrDefault(dimension.Id, new List<Project>());
                                            var hasAnyItems = goals.Any() || dimTasks.Any() || dimProjects.Any();
                                        }
                                        @if (hasAnyItems)
                                        {
                                            <span class="oi @(isExpanded ? "oi-chevron-top" : "oi-chevron-bottom") ms-2 text-muted small"></span>
                                        }
                                    </div>
                                    <div class="rating-bar">
                                        <div class="rating-fill" style="width: @(rating * 10)%; background-color: @dimension.Color;"></div>
                                    </div>
                                    @{
                                        var tasks = _taskListByDimension.GetValueOrDefault(dimension.Id, new List<TodoTask>());
                                        var projects = _projectsByDimension.GetValueOrDefault(dimension.Id, new List<Project>());
                                        var hasItems = tasksCount > 0 || goals.Any() || projects.Any();
                                    }
                                    <div class="area-stats">
                                        @if (hasItems)
                                        {
                                            <span class="text-muted small">
                                                @if (goals.Any())
                                                {
                                                    <span><span class="oi oi-target me-1"></span>@goals.Count goal@(goals.Count != 1 ? "s" : "")</span>
                                                }
                                                @if (projects.Any())
                                                {
                                                    <span class="@(goals.Any() ? "ms-2" : "")"><span class="oi oi-folder me-1"></span>@projects.Count project@(projects.Count != 1 ? "s" : "")</span>
                                                }
                                                @if (tasksCount > 0)
                                                {
                                                    <span class="@(goals.Any() || projects.Any() ? "ms-2" : "")"><span class="oi oi-task me-1"></span>@tasksCount task@(tasksCount != 1 ? "s" : "")</span>
                                                }
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">No linked items</span>
                                        }
                                    </div>

                                    @* Expanded items list *@
                                    @if (isExpanded && hasItems)
                                    {
                                        <div class="dimension-items">
                                            @if (goals.Any())
                                            {
                                                <div class="item-section">
                                                    <div class="item-section-header">
                                                        <span class="oi oi-target me-1"></span>Goals
                                                    </div>
                                                    @foreach (var goal in goals.Take(3))
                                                    {
                                                        <div class="linked-item goal" @onclick="() => NavigateToGoal(goal.Id)" @onclick:stopPropagation="true">
                                                            <span class="item-indicator" style="background-color: @dimension.Color;"></span>
                                                            <span class="item-title">@goal.Title</span>
                                                            <span class="item-meta">@goal.ProgressPercent%</span>
                                                        </div>
                                                    }
                                                    @if (goals.Count > 3)
                                                    {
                                                        <div class="more-items text-muted small">+@(goals.Count - 3) more</div>
                                                    }
                                                </div>
                                            }
                                            @if (projects.Any())
                                            {
                                                <div class="item-section">
                                                    <div class="item-section-header">
                                                        <span class="oi oi-folder me-1"></span>Projects
                                                    </div>
                                                    @foreach (var project in projects.Take(3))
                                                    {
                                                        <div class="linked-item project" @onclick="() => NavigateToProject(project.Id)" @onclick:stopPropagation="true">
                                                            <span class="item-indicator" style="background-color: var(--color-primary);"></span>
                                                            <span class="item-title">@project.Name</span>
                                                            <span class="item-meta badge @GetProjectStatusBadge(project.Status)">@project.Status</span>
                                                        </div>
                                                    }
                                                    @if (projects.Count > 3)
                                                    {
                                                        <div class="more-items text-muted small">+@(projects.Count - 3) more</div>
                                                    }
                                                </div>
                                            }
                                            @if (tasks.Any())
                                            {
                                                <div class="item-section">
                                                    <div class="item-section-header">
                                                        <span class="oi oi-task me-1"></span>Tasks
                                                    </div>
                                                    @foreach (var task in tasks.Take(3))
                                                    {
                                                        <div class="linked-item task" @onclick="() => NavigateToTask(task.Id)" @onclick:stopPropagation="true">
                                                            <span class="item-indicator" style="background-color: var(--color-warning);"></span>
                                                            <span class="item-title">@task.Title</span>
                                                            <span class="item-meta badge @GetTaskPriorityBadge(task.Priority)">P@(task.Priority)</span>
                                                        </div>
                                                    }
                                                    @if (tasks.Count > 3)
                                                    {
                                                        <div class="more-items text-muted small">+@(tasks.Count - 3) more</div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _showAssessment = false;
    private bool _showInsights = true;
    private int _currentAreaIndex = 0;
    private Dictionary<string, int> _currentRatings = new();
    private Dictionary<string, int> _ratings = new();
    private Dictionary<string, int> _tasksByDimension = new();
    private Dictionary<string, List<TodoTask>> _taskListByDimension = new();
    private Dictionary<string, List<Goal>> _goalsByDimension = new();
    private Dictionary<string, List<Project>> _projectsByDimension = new();
    private DateTime? _lastAssessmentDate;
    private AppMode _currentMode = AppMode.Balanced;
    private List<BalanceDimension> _dimensions = new();
    private string? _expandedDimension;

    // For AI panel
    private IReadOnlyList<Goal> _activeGoals = Array.Empty<Goal>();
    private IReadOnlyList<TodoTask> _activeTasks = Array.Empty<TodoTask>();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            // Get current mode and dimensions
            _currentMode = await BalanceDimensionService.GetCurrentModeAsync();
            var enabledDimensions = await BalanceDimensionService.GetEnabledDimensionsAsync();
            _dimensions = enabledDimensions.OrderBy(d => d.SortOrder).ToList();

            // Load saved ratings for current mode
            _ratings = await BalanceDimensionService.GetBalanceRatingsAsync();

            // Initialize current ratings with saved values
            _currentRatings = new Dictionary<string, int>();
            foreach (var dimension in _dimensions)
            {
                _currentRatings[dimension.Id] = _ratings.GetValueOrDefault(dimension.Id, 5);
            }

            // Load goals and tasks
            var allGoals = await GoalRepository.GetAllAsync();
            var activeGoals = allGoals.Where(g => g.Status != GoalStatus.Completed && g.Status != GoalStatus.Archived).ToList();
            _activeGoals = activeGoals;

            var tasks = await TaskService.GetAllAsync();
            var activeTasks = tasks.Where(t =>
                t.Status != TodoTaskStatus.Completed &&
                t.Status != TodoTaskStatus.Deleted).ToList();
            _activeTasks = activeTasks;

            // Group goals by dimension
            _goalsByDimension = new Dictionary<string, List<Goal>>();
            foreach (var dimension in _dimensions)
            {
                // Goals explicitly linked to this dimension
                var linkedGoals = activeGoals.Where(g =>
                    g.BalanceDimensionIds.Contains(dimension.Id) ||
                    g.PrimaryBalanceDimensionId == dimension.Id).ToList();

                // Also include goals that match the dimension's category mappings
                var categoryMappedGoals = activeGoals.Where(g =>
                    !linkedGoals.Contains(g) &&
                    dimension.CategoryMappings.Contains(g.Category.ToString())).ToList();

                _goalsByDimension[dimension.Id] = linkedGoals.Concat(categoryMappedGoals).ToList();
            }

            // Load projects
            var allProjects = await ProjectService.GetAllAsync();
            var activeProjects = allProjects.Where(p =>
                p.Status != ProjectStatus.Completed &&
                p.Status != ProjectStatus.Deleted).ToList();

            // Group tasks by dimension (using category/keyword mapping)
            _tasksByDimension = new Dictionary<string, int>();
            _taskListByDimension = new Dictionary<string, List<TodoTask>>();
            foreach (var dimension in _dimensions)
            {
                var matchingTasks = activeTasks.Where(t =>
                    MatchesDimension(t.Category, t.Title, dimension)).ToList();
                _tasksByDimension[dimension.Id] = matchingTasks.Count;
                _taskListByDimension[dimension.Id] = matchingTasks;
            }

            // Group projects by dimension (using category/keyword mapping)
            _projectsByDimension = new Dictionary<string, List<Project>>();
            foreach (var dimension in _dimensions)
            {
                var matchingProjects = activeProjects.Where(p =>
                    MatchesDimension(p.Category, p.Name, dimension)).ToList();
                _projectsByDimension[dimension.Id] = matchingProjects;
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private bool MatchesDimension(string? category, string? title, BalanceDimension dimension)
    {
        if (!string.IsNullOrEmpty(category))
        {
            if (dimension.CategoryMappings.Any(cm =>
                category.Equals(cm, StringComparison.OrdinalIgnoreCase)))
            {
                return true;
            }
        }

        if (!string.IsNullOrEmpty(title))
        {
            var lowerTitle = title.ToLowerInvariant();
            if (dimension.KeywordMappings.Any(kw => lowerTitle.Contains(kw.ToLowerInvariant())))
            {
                return true;
            }
        }

        return false;
    }

    private async Task SwitchMode(AppMode mode)
    {
        if (_currentMode == mode) return;

        _isLoading = true;
        try
        {
            // Save current ratings before switching
            if (_ratings.Any())
            {
                await BalanceDimensionService.SaveBalanceRatingsAsync(_ratings);
            }

            // Switch mode (don't seed contexts, just viewing different dimensions)
            await BalanceDimensionService.SetModeAsync(mode, seedContexts: false);
            _currentMode = mode;
            _expandedDimension = null;

            // Reload data for new mode
            await LoadData();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetPageTitle() => _currentMode switch
    {
        AppMode.Work => "Professional Balance",
        AppMode.Life => "Life Balance",
        AppMode.Balanced => "Life Balance",
        _ => "Balance"
    };

    private string GetModeLabel() => _currentMode switch
    {
        AppMode.Work => "professional",
        AppMode.Life => "life",
        AppMode.Balanced => "life",
        _ => ""
    };

    private void ToggleDimension(string dimensionId)
    {
        _expandedDimension = _expandedDimension == dimensionId ? null : dimensionId;
    }

    private void NavigateToGoal(Guid goalId)
    {
        Navigation.NavigateTo($"/goals/{goalId}");
    }

    private void StartAssessment()
    {
        _showAssessment = true;
        _currentAreaIndex = 0;
        _currentRatings = _dimensions.ToDictionary(
            d => d.Id,
            d => _ratings.GetValueOrDefault(d.Id, 5));
    }

    private void SetRating(string dimensionId, int rating)
    {
        _currentRatings[dimensionId] = rating;
    }

    private void NextArea()
    {
        if (_currentAreaIndex < _dimensions.Count - 1)
        {
            _currentAreaIndex++;
        }
    }

    private void PreviousArea()
    {
        if (_currentAreaIndex > 0)
        {
            _currentAreaIndex--;
        }
    }

    private async Task CompleteAssessment()
    {
        _ratings = new Dictionary<string, int>(_currentRatings);
        _lastAssessmentDate = DateTime.Now;

        // Save ratings for current mode
        await BalanceDimensionService.SaveBalanceRatingsAsync(_ratings);

        _showAssessment = false;
        DataChangeNotification.NotifyDataChanged();
    }

    private double GetOverallScore()
    {
        if (!_dimensions.Any()) return 0;
        return _dimensions.Average(d => GetEffectiveRating(d.Id));
    }

    private double CalculateVariance()
    {
        if (!_dimensions.Any()) return 0;
        var ratings = _dimensions.Select(d => (double)GetEffectiveRating(d.Id)).ToList();
        var avg = ratings.Average();
        return ratings.Select(r => Math.Pow(r - avg, 2)).Average();
    }

    private string GetRatingColor(int rating) => rating switch
    {
        >= 8 => "#10b981",
        >= 6 => "#f59e0b",
        >= 4 => "#f97316",
        _ => "#ef4444"
    };

    private int GetEffectiveRating(string dimensionId)
    {
        // If user has rated this dimension, use their rating
        if (_ratings.TryGetValue(dimensionId, out var userRating))
        {
            return userRating;
        }

        // Otherwise, calculate based on linked goals and tasks
        var goals = _goalsByDimension.GetValueOrDefault(dimensionId, new List<Goal>());
        var tasksCount = _tasksByDimension.GetValueOrDefault(dimensionId, 0);

        // Calculate a score based on activity in this dimension
        // Each goal = 2 points, each task = 0.5 points, capped at 8
        // Base score of 3 to not make empty areas look alarming
        var activityScore = 3 + (goals.Count * 2) + (tasksCount * 0.5);

        // Boost score if goals have good progress
        var avgGoalProgress = goals.Any() ? goals.Average(g => g.ProgressPercent) : 0;
        var progressBonus = avgGoalProgress / 25; // Up to 4 points for 100% progress

        var calculatedRating = (int)Math.Min(10, Math.Max(1, activityScore + progressBonus));
        return calculatedRating;
    }

    private void ToggleInsights()
    {
        _showInsights = !_showInsights;
    }

    private int GetInsightCount()
    {
        var count = 0;
        var lowestDimension = _dimensions.OrderBy(d => GetEffectiveRating(d.Id)).FirstOrDefault();
        var highestDimension = _dimensions.OrderByDescending(d => GetEffectiveRating(d.Id)).FirstOrDefault();
        var variance = CalculateVariance();
        var avgRating = GetOverallScore();

        if (lowestDimension != null && GetEffectiveRating(lowestDimension.Id) < 5) count++;
        if (highestDimension != null && GetEffectiveRating(highestDimension.Id) >= 8) count++;
        if (variance > 4) count++;
        else if (variance < 2 && avgRating >= 6) count++;

        var dimensionsWithoutGoals = _dimensions.Where(d =>
            !_goalsByDimension.GetValueOrDefault(d.Id, new List<Goal>()).Any() &&
            GetEffectiveRating(d.Id) < 6).ToList();
        if (dimensionsWithoutGoals.Any()) count++;

        return count;
    }

    private void NavigateToProject(Guid projectId)
    {
        Navigation.NavigateTo($"/projects/{projectId}");
    }

    private void NavigateToTask(Guid taskId)
    {
        Navigation.NavigateTo($"/tasks/{taskId}");
    }

    private string GetProjectStatusBadge(ProjectStatus status) => status switch
    {
        ProjectStatus.Active => "bg-primary",
        ProjectStatus.OnHold => "bg-warning text-dark",
        ProjectStatus.Completed => "bg-success",
        _ => "bg-secondary"
    };

    private string GetTaskPriorityBadge(int priority) => priority switch
    {
        1 => "bg-danger",
        2 => "bg-warning text-dark",
        3 => "bg-info",
        _ => "bg-secondary"
    };

    private async Task HandleTasksCreated()
    {
        await LoadData();
        DataChangeNotification.NotifyDataChanged();
    }

    private async Task HandleGoalCreated()
    {
        await LoadData();
        DataChangeNotification.NotifyDataChanged();
    }
}
