@page "/projects/{Id:guid}"
@using SelfOrganizer.Core.Models
@using SelfOrganizer.Core.Interfaces
@inject IProjectService ProjectService
@inject ITaskService TaskService
@inject IGoalService GoalService
@inject NavigationManager Navigation

@if (_isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_project == null)
{
    <div class="alert alert-warning">Project not found</div>
}
else
{
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/projects">Projects</a></li>
            <li class="breadcrumb-item active">@_project.Name</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h3 class="mb-1">
                <SelfOrganizer.App.Components.Shared.PriorityIndicator Priority="@_project.Priority" />
                @_project.Name
            </h3>
            <span class="badge bg-secondary">@_project.Status</span>
            @if (!_hasNextAction && _project.Status == ProjectStatus.Active)
            {
                <span class="badge bg-warning text-dark ms-2">No Next Action</span>
            }
        </div>
        <div class="btn-group">
            @if (_project.Status == ProjectStatus.Active)
            {
                <button class="btn btn-success" @onclick="Complete">
                    <span class="oi oi-check me-1"></span> Complete
                </button>
            }
            <button class="btn btn-outline-primary" @onclick="() => _isEditing = true">
                <span class="oi oi-pencil me-1"></span> Edit
            </button>
            <button class="btn btn-outline-danger" @onclick="() => _showDeleteConfirm = true">
                <span class="oi oi-trash me-1"></span> Delete
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            @if (!string.IsNullOrEmpty(_project.DesiredOutcome))
            {
                <div class="card mb-4">
                    <div class="card-header">Desired Outcome</div>
                    <div class="card-body">
                        <p class="mb-0">@_project.DesiredOutcome</p>
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(_project.Description))
            {
                <div class="card mb-4">
                    <div class="card-header">Description</div>
                    <div class="card-body">
                        <p class="mb-0" style="white-space: pre-wrap;">@_project.Description</p>
                    </div>
                </div>
            }

            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Tasks (@_tasks.Count)</span>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-primary" @onclick="ShowAddTaskModal">
                            <span class="oi oi-plus me-1"></span> New Task
                        </button>
                        <button class="btn btn-outline-primary" @onclick="() => _showLinkExistingTaskModal = true">
                            <span class="oi oi-link-intact me-1"></span> Link Existing
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (!_tasks.Any())
                    {
                        <p class="text-muted text-center py-3">No tasks yet. Add a task to define the next action.</p>
                    }
                    else
                    {
                        @foreach (var task in _tasks.OrderBy(t => t.Status == TodoTaskStatus.Completed).ThenBy(t => t.Priority))
                        {
                            <div class="d-flex align-items-center py-2 border-bottom task-row">
                                <button class="btn btn-sm @(task.Status == TodoTaskStatus.Completed ? "btn-secondary" : "btn-outline-success") me-2"
                                        @onclick="() => ToggleComplete(task)" disabled="@(task.Status == TodoTaskStatus.Completed)"
                                        title="@(task.Status == TodoTaskStatus.Completed ? "Already completed" : "Mark complete")">
                                    <span class="oi oi-check"></span>
                                </button>
                                <div class="flex-grow-1">
                                    <a href="/tasks/@task.Id" class="@(task.Status == TodoTaskStatus.Completed ? "text-decoration-line-through text-muted" : "")">
                                        @task.Title
                                    </a>
                                    <div class="small text-muted">
                                        <span class="badge bg-light text-dark">@task.Status</span>
                                        @if (task.EstimatedMinutes > 0)
                                        {
                                            <SelfOrganizer.App.Components.Shared.TimeDisplay Minutes="@task.EstimatedMinutes" />
                                        }
                                        @if (task.DueDate.HasValue)
                                        {
                                            <span class="@(task.DueDate.Value < DateTime.Today ? "text-danger" : "text-muted")">
                                                Due @task.DueDate.Value.ToString("MMM d")
                                            </span>
                                        }
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <SelfOrganizer.App.Components.Shared.PriorityIndicator Priority="@task.Priority" />
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-muted p-1" data-bs-toggle="dropdown" title="Task actions">
                                            <span class="oi oi-ellipses"></span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="/tasks/@task.Id"><span class="oi oi-eye me-2"></span>View Details</a></li>
                                            <li><button class="dropdown-item" @onclick="() => ShowEditTaskModal(task)"><span class="oi oi-pencil me-2"></span>Quick Edit</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            @if (task.Status != TodoTaskStatus.NextAction)
                                            {
                                                <li><button class="dropdown-item" @onclick="() => SetTaskStatus(task, TodoTaskStatus.NextAction)"><span class="oi oi-media-play me-2"></span>Set as Next Action</button></li>
                                            }
                                            @if (task.Status != TodoTaskStatus.WaitingFor)
                                            {
                                                <li><button class="dropdown-item" @onclick="() => SetTaskStatus(task, TodoTaskStatus.WaitingFor)"><span class="oi oi-clock me-2"></span>Mark Waiting For</button></li>
                                            }
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button class="dropdown-item" @onclick="() => UnlinkTaskFromProject(task)"><span class="oi oi-link-broken me-2"></span>Remove from Project</button></li>
                                            <li><button class="dropdown-item text-danger" @onclick="() => ShowDeleteTaskConfirm(task)"><span class="oi oi-trash me-2"></span>Delete Task</button></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">Progress</div>
                <div class="card-body">
                    @if (_tasks.Any())
                    {
                        var completed = _tasks.Count(t => t.Status == TodoTaskStatus.Completed);
                        var total = _tasks.Count;
                        var percent = (int)((double)completed / total * 100);
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: @percent%">@percent%</div>
                        </div>
                        <p class="text-center mb-0">@completed of @total tasks completed</p>
                    }
                    else
                    {
                        <p class="text-muted text-center mb-0">No tasks to track</p>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-header">Properties</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Status</span>
                        <span class="badge bg-secondary">@_project.Status</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Priority</span>
                        <span>@(_project.Priority == 1 ? "High" : _project.Priority == 2 ? "Normal" : "Low")</span>
                    </li>
                    @if (_project.DueDate.HasValue)
                    {
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Due Date</span>
                            <span class="@(_project.DueDate.Value < DateTime.UtcNow ? "text-danger" : "")">
                                @_project.DueDate.Value.ToString("MMM d, yyyy")
                            </span>
                        </li>
                    }
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Created</span>
                        <span>@_project.CreatedAt.ToString("MMM d, yyyy")</span>
                    </li>
                    @if (_project.CompletedAt.HasValue)
                    {
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Completed</span>
                            <span class="text-success">@_project.CompletedAt.Value.ToString("MMM d, yyyy")</span>
                        </li>
                    }
                    @if (_project.Tags.Any())
                    {
                        <li class="list-group-item">
                            <div class="mb-1"><strong>Tags</strong></div>
                            <div class="d-flex flex-wrap gap-1">
                                @foreach (var tag in _project.Tags)
                                {
                                    <a href="/tags/@tag" class="badge bg-primary text-decoration-none">#@tag</a>
                                }
                            </div>
                        </li>
                    }
                    @if (!string.IsNullOrEmpty(_project.Url))
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>External Link</span>
                            <a href="@_project.Url" target="_blank" class="btn btn-sm btn-outline-primary">
                                <span class="oi oi-external-link me-1"></span>Open
                            </a>
                        </li>
                    }
                </ul>
            </div>

            @* Linked Goals *@
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><span class="oi oi-target me-1"></span>Linked Goals</span>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary">@_linkedGoals.Count</span>
                        <button class="btn btn-sm btn-outline-primary" @onclick="ShowLinkGoalModal" title="Link to goal">
                            <span class="oi oi-plus"></span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (_linkedGoals.Any())
                    {
                        <ul class="list-unstyled mb-0">
                            @foreach (var goal in _linkedGoals)
                            {
                                <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                    <a href="/goals" class="text-decoration-none">
                                        <span class="oi oi-target me-1"></span>
                                        @goal.Title
                                    </a>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge @GetGoalStatusClass(goal.Status)">@goal.Status</span>
                                        <button class="btn btn-sm btn-link text-danger p-0" @onclick="() => UnlinkGoal(goal.Id)" title="Unlink goal">
                                            <span class="oi oi-x"></span>
                                        </button>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted small mb-0">No linked goals. Link this project to goals to track strategic alignment.</p>
                    }
                </div>
            </div>

            @* Link Existing Task *@
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><span class="oi oi-link-intact me-1"></span>Link Existing Task</span>
                    <button class="btn btn-sm btn-outline-success" @onclick="ShowLinkExistingTaskModal" title="Link existing task">
                        <span class="oi oi-plus"></span>
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-0">Link tasks that already exist but aren't part of this project yet.</p>
                </div>
            </div>
        </div>
    </div>
}

@* Add Task Modal *@
<SelfOrganizer.App.Components.Shared.Modal Title="Add Task to Project" IsVisible="@_showAddTaskModal" OnClose="() => _showAddTaskModal = false">
    <ChildContent>
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" @bind="_newTaskTitle" />
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Estimated Minutes</label>
                <input type="number" class="form-control" @bind="_newTaskMinutes" min="1" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Priority</label>
                <select class="form-select" @bind="_newTaskPriority">
                    <option value="1">High</option>
                    <option value="2">Normal</option>
                    <option value="3">Low</option>
                </select>
            </div>
        </div>
    </ChildContent>
    <Footer>
        <button class="btn btn-secondary" @onclick="() => _showAddTaskModal = false">Cancel</button>
        <button class="btn btn-primary" @onclick="AddTask" disabled="@string.IsNullOrWhiteSpace(_newTaskTitle)">Add Task</button>
    </Footer>
</SelfOrganizer.App.Components.Shared.Modal>

@* Edit Modal *@
<SelfOrganizer.App.Components.Shared.Modal Title="Edit Project" IsVisible="@_isEditing" OnClose="() => _isEditing = false" Size="modal-lg">
    <ChildContent>
        <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" @bind="_editName" />
        </div>
        <div class="mb-3">
            <label class="form-label">Desired Outcome</label>
            <textarea class="form-control" @bind="_editOutcome" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" @bind="_editDescription" rows="3"></textarea>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Priority</label>
                <select class="form-select" @bind="_editPriority">
                    <option value="1">High</option>
                    <option value="2">Normal</option>
                    <option value="3">Low</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Status</label>
                <select class="form-select" @bind="_editStatus">
                    <option value="@ProjectStatus.Active">Active</option>
                    <option value="@ProjectStatus.OnHold">On Hold</option>
                    <option value="@ProjectStatus.SomedayMaybe">Someday/Maybe</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-control" @bind="_editDueDate" />
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Tags</label>
            <input type="text" class="form-control" @bind="_editTags" placeholder="Use #hashtags separated by spaces" />
        </div>
        <div class="mb-3">
            <label class="form-label">Project Color</label>
            <div class="d-flex gap-2 flex-wrap align-items-center">
                @foreach (var color in _projectColors)
                {
                    <button type="button"
                            class="color-swatch @(_editColor == color ? "selected" : "")"
                            style="background-color: @color"
                            @onclick="() => _editColor = color"
                            title="@color">
                    </button>
                }
                <input type="color"
                       class="form-control form-control-color"
                       value="@(_editColor ?? "#3b82f6")"
                       @onchange="OnCustomColorSelected"
                       title="Custom color" />
                @if (!string.IsNullOrEmpty(_editColor))
                {
                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => _editColor = null" title="Clear color">
                        <span class="oi oi-x"></span>
                    </button>
                }
            </div>
            <small class="text-muted">Used in calendar to identify this project's tasks</small>
        </div>
        <div class="mb-3">
            <label class="form-label">External URL</label>
            <input type="url" class="form-control" @bind="_editUrl" placeholder="https://..." />
        </div>
    </ChildContent>
    <Footer>
        <button class="btn btn-secondary" @onclick="() => _isEditing = false">Cancel</button>
        <button class="btn btn-primary" @onclick="SaveEdit">Save</button>
    </Footer>
</SelfOrganizer.App.Components.Shared.Modal>

<SelfOrganizer.App.Components.Shared.ConfirmDialog
    Title="Delete Project"
    Message="Are you sure you want to delete this project? Tasks will not be deleted."
    IsVisible="@_showDeleteConfirm"
    OnConfirm="ConfirmDelete"
    OnCancel="() => _showDeleteConfirm = false" />

@* Link Goal Modal *@
<SelfOrganizer.App.Components.Shared.Modal Title="Link Goal to Project" IsVisible="@_showLinkGoalModal" OnClose="() => _showLinkGoalModal = false">
    <ChildContent>
        <div class="mb-3">
            <label class="form-label">Search Goals</label>
            <input type="text" class="form-control" @bind="_goalSearchQuery" @bind:event="oninput" placeholder="Type to search..." />
        </div>
        <div class="list-group" style="max-height: 300px; overflow-y: auto;">
            @foreach (var goal in GetFilteredGoalsForLinking())
            {
                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        @onclick="() => LinkGoal(goal.Id)">
                    <div>
                        <span class="oi oi-target me-2"></span>
                        @goal.Title
                    </div>
                    <span class="badge @GetGoalStatusClass(goal.Status)">@goal.Status</span>
                </button>
            }
            @if (!GetFilteredGoalsForLinking().Any())
            {
                <div class="text-muted text-center py-3">
                    @if (string.IsNullOrWhiteSpace(_goalSearchQuery))
                    {
                        <span>All goals are already linked to this project.</span>
                    }
                    else
                    {
                        <span>No matching goals found.</span>
                    }
                </div>
            }
        </div>
    </ChildContent>
    <Footer>
        <button class="btn btn-secondary" @onclick="() => _showLinkGoalModal = false">Close</button>
    </Footer>
</SelfOrganizer.App.Components.Shared.Modal>

@* Edit Task Modal *@
<SelfOrganizer.App.Components.Shared.Modal Title="Edit Task" IsVisible="@_showEditTaskModal" OnClose="() => _showEditTaskModal = false" Size="modal-lg">
    <ChildContent>
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" @bind="_editTaskTitle" />
        </div>
        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" @bind="_editTaskDescription" rows="2"></textarea>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Priority</label>
                <select class="form-select" @bind="_editTaskPriority">
                    <option value="1">High</option>
                    <option value="2">Normal</option>
                    <option value="3">Low</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Estimated Minutes</label>
                <input type="number" class="form-control" @bind="_editTaskMinutes" min="5" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-control" @bind="_editTaskDueDate" />
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Status</label>
                <select class="form-select" @bind="_editTaskStatus">
                    <option value="@TodoTaskStatus.Inbox">Inbox</option>
                    <option value="@TodoTaskStatus.NextAction">Next Action</option>
                    <option value="@TodoTaskStatus.Active">Active</option>
                    <option value="@TodoTaskStatus.WaitingFor">Waiting For</option>
                    <option value="@TodoTaskStatus.Scheduled">Scheduled</option>
                    <option value="@TodoTaskStatus.SomedayMaybe">Someday/Maybe</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Energy Level (1-5)</label>
                <select class="form-select" @bind="_editTaskEnergyLevel">
                    <option value="">Any</option>
                    <option value="1">1 - Very Low</option>
                    <option value="2">2 - Low</option>
                    <option value="3">3 - Medium</option>
                    <option value="4">4 - High</option>
                    <option value="5">5 - Very High</option>
                </select>
            </div>
        </div>
    </ChildContent>
    <Footer>
        <button class="btn btn-secondary" @onclick="() => _showEditTaskModal = false">Cancel</button>
        <button class="btn btn-primary" @onclick="SaveEditTask">Save</button>
    </Footer>
</SelfOrganizer.App.Components.Shared.Modal>

@* Delete Task Confirm *@
<SelfOrganizer.App.Components.Shared.ConfirmDialog
    Title="Delete Task"
    Message="Are you sure you want to delete this task? This action cannot be undone."
    IsVisible="@_showDeleteTaskConfirm"
    OnConfirm="ConfirmDeleteTask"
    OnCancel="() => _showDeleteTaskConfirm = false" />

@* Link Existing Task Modal *@
<SelfOrganizer.App.Components.Shared.Modal Title="Link Existing Task to Project" IsVisible="@_showLinkExistingTaskModal" OnClose="() => _showLinkExistingTaskModal = false">
    <ChildContent>
        <div class="mb-3">
            <label class="form-label">Search Tasks</label>
            <input type="text" class="form-control" @bind="_taskSearchQuery" @bind:event="oninput" placeholder="Type to search..." />
        </div>
        <div class="list-group" style="max-height: 300px; overflow-y: auto;">
            @foreach (var task in GetFilteredTasksForLinking())
            {
                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        @onclick="() => LinkExistingTask(task.Id)">
                    <div>
                        <span class="oi oi-task me-2"></span>
                        @task.Title
                    </div>
                    <span class="badge bg-secondary">@task.Status</span>
                </button>
            }
            @if (!GetFilteredTasksForLinking().Any())
            {
                <div class="text-muted text-center py-3">
                    @if (string.IsNullOrWhiteSpace(_taskSearchQuery))
                    {
                        <span>No unassigned tasks available.</span>
                    }
                    else
                    {
                        <span>No matching tasks found.</span>
                    }
                </div>
            }
        </div>
    </ChildContent>
    <Footer>
        <button class="btn btn-secondary" @onclick="() => _showLinkExistingTaskModal = false">Close</button>
    </Footer>
</SelfOrganizer.App.Components.Shared.Modal>

@code {
    [Parameter] public Guid Id { get; set; }

    private Project? _project;
    private List<TodoTask> _tasks = new();
    private List<Goal> _linkedGoals = new();
    private List<Goal> _allGoals = new();
    private List<TodoTask> _allTasks = new();
    private bool _hasNextAction;
    private bool _isLoading = true;
    private bool _isEditing = false;
    private bool _showDeleteConfirm = false;
    private bool _showAddTaskModal = false;
    private bool _showLinkGoalModal = false;
    private bool _showLinkExistingTaskModal = false;
    private string _goalSearchQuery = string.Empty;
    private string _taskSearchQuery = string.Empty;

    // Edit fields
    private string _editName = string.Empty;
    private string _editOutcome = string.Empty;
    private string _editDescription = string.Empty;
    private int _editPriority = 2;
    private ProjectStatus _editStatus = ProjectStatus.Active;
    private DateTime? _editDueDate;
    private string _editTags = string.Empty;
    private string? _editUrl;
    private string? _editColor;

    // Predefined project colors
    private static readonly string[] _projectColors = new[]
    {
        "#3b82f6", // Blue
        "#10b981", // Green
        "#f59e0b", // Amber
        "#8b5cf6", // Purple
        "#ec4899", // Pink
        "#06b6d4", // Cyan
        "#f97316", // Orange
        "#6366f1", // Indigo
        "#14b8a6", // Teal
        "#84cc16"  // Lime
    };

    // New task fields
    private string _newTaskTitle = string.Empty;
    private int _newTaskMinutes = 30;
    private int _newTaskPriority = 2;

    // Edit task fields
    private bool _showEditTaskModal = false;
    private TodoTask? _editingTask = null;
    private string _editTaskTitle = string.Empty;
    private string _editTaskDescription = string.Empty;
    private int _editTaskPriority = 2;
    private int _editTaskMinutes = 30;
    private DateTime? _editTaskDueDate;
    private TodoTaskStatus _editTaskStatus = TodoTaskStatus.NextAction;
    private string _editTaskEnergyLevel = string.Empty;

    // Delete task fields
    private bool _showDeleteTaskConfirm = false;
    private TodoTask? _taskToDelete = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
    }

    private async Task LoadProject()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetByIdAsync(Id);
            if (_project != null)
            {
                var tasksTask = TaskService.GetByProjectAsync(Id);
                var hasNextActionTask = ProjectService.HasNextActionAsync(Id);
                var allGoalsTask = GoalService.GetAllAsync();
                var allTasksTask = TaskService.GetAllAsync();

                await Task.WhenAll(tasksTask, hasNextActionTask, allGoalsTask, allTasksTask);

                _tasks = (await tasksTask)
                    .Where(t => t.Status != TodoTaskStatus.Deleted)
                    .ToList();
                _hasNextAction = await hasNextActionTask;
                _allGoals = (await allGoalsTask).Where(g => g.Status != GoalStatus.Archived).ToList();
                _allTasks = (await allTasksTask)
                    .Where(t => t.Status != TodoTaskStatus.Deleted && t.Status != TodoTaskStatus.Completed && !t.ProjectId.HasValue)
                    .ToList();

                // Load linked goals (goals that have this project in their LinkedProjectIds)
                _linkedGoals = _allGoals.Where(g => g.LinkedProjectIds.Contains(Id)).ToList();

                // Initialize edit fields
                _editName = _project.Name;
                _editOutcome = _project.DesiredOutcome ?? string.Empty;
                _editDescription = _project.Description ?? string.Empty;
                _editPriority = _project.Priority;
                _editStatus = _project.Status;
                _editDueDate = _project.DueDate;
                _editTags = _project.Tags.Any() ? string.Join(" ", _project.Tags.Select(t => $"#{t}")) : string.Empty;
                _editUrl = _project.Url;
                _editColor = _project.Color;
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task Complete()
    {
        if (_project != null)
        {
            await ProjectService.CompleteAsync(_project.Id);
            await LoadProject();
        }
    }

    private async Task SaveEdit()
    {
        if (_project != null)
        {
            _project.Name = _editName;
            _project.DesiredOutcome = _editOutcome;
            _project.Description = _editDescription;
            _project.Priority = _editPriority;
            _project.Status = _editStatus;
            _project.DueDate = _editDueDate;
            _project.Tags = SelfOrganizer.Core.Services.TagParsingService.ExtractTags(_editTags);
            _project.Url = string.IsNullOrWhiteSpace(_editUrl) ? null : _editUrl;
            _project.Color = _editColor;
            await ProjectService.UpdateAsync(_project);
            _isEditing = false;
            await LoadProject();
        }
    }

    private void OnCustomColorSelected(ChangeEventArgs e)
    {
        _editColor = e.Value?.ToString();
    }

    private async Task ConfirmDelete()
    {
        if (_project != null)
        {
            await ProjectService.DeleteAsync(_project.Id);
            Navigation.NavigateTo("/projects");
        }
    }

    private void ShowAddTaskModal()
    {
        _newTaskTitle = string.Empty;
        _newTaskMinutes = 30;
        _newTaskPriority = 2;
        _showAddTaskModal = true;
    }

    private async Task AddTask()
    {
        if (_project == null || string.IsNullOrWhiteSpace(_newTaskTitle)) return;

        var task = new TodoTask
        {
            Title = _newTaskTitle,
            ProjectId = _project.Id,
            Status = TodoTaskStatus.NextAction,
            EstimatedMinutes = _newTaskMinutes,
            Priority = _newTaskPriority
        };
        await TaskService.CreateAsync(task);
        _showAddTaskModal = false;
        await LoadProject();
    }

    private async Task ToggleComplete(TodoTask task)
    {
        if (task.Status != TodoTaskStatus.Completed)
        {
            await TaskService.CompleteAsync(task.Id);
            await LoadProject();
        }
    }

    // Goal linking methods
    private void ShowLinkGoalModal()
    {
        _goalSearchQuery = string.Empty;
        _showLinkGoalModal = true;
    }

    private IEnumerable<Goal> GetFilteredGoalsForLinking()
    {
        var linkedGoalIds = _linkedGoals.Select(g => g.Id).ToHashSet();
        var available = _allGoals.Where(g => !linkedGoalIds.Contains(g.Id) && g.Status == GoalStatus.Active);

        if (string.IsNullOrWhiteSpace(_goalSearchQuery))
            return available.Take(20);

        return available
            .Where(g => g.Title.Contains(_goalSearchQuery, StringComparison.OrdinalIgnoreCase))
            .Take(20);
    }

    private async Task LinkGoal(Guid goalId)
    {
        await GoalService.LinkProjectAsync(goalId, Id);
        await LoadProject();
    }

    private async Task UnlinkGoal(Guid goalId)
    {
        await GoalService.UnlinkProjectAsync(goalId, Id);
        await LoadProject();
    }

    private string GetGoalStatusClass(GoalStatus status) => status switch
    {
        GoalStatus.Active => "bg-success",
        GoalStatus.OnHold => "bg-warning text-dark",
        GoalStatus.Completed => "bg-info",
        GoalStatus.Archived => "bg-secondary",
        _ => "bg-secondary"
    };

    // Task linking methods
    private void ShowLinkExistingTaskModal()
    {
        _taskSearchQuery = string.Empty;
        _showLinkExistingTaskModal = true;
    }

    private IEnumerable<TodoTask> GetFilteredTasksForLinking()
    {
        if (string.IsNullOrWhiteSpace(_taskSearchQuery))
            return _allTasks.Take(20);

        return _allTasks
            .Where(t => t.Title.Contains(_taskSearchQuery, StringComparison.OrdinalIgnoreCase))
            .Take(20);
    }

    private async Task LinkExistingTask(Guid taskId)
    {
        var task = await TaskService.GetByIdAsync(taskId);
        if (task != null)
        {
            task.ProjectId = Id;
            await TaskService.UpdateAsync(task);
            _showLinkExistingTaskModal = false;
            await LoadProject();
        }
    }

    // Task CRUD methods
    private void ShowEditTaskModal(TodoTask task)
    {
        _editingTask = task;
        _editTaskTitle = task.Title;
        _editTaskDescription = task.Description ?? string.Empty;
        _editTaskPriority = task.Priority;
        _editTaskMinutes = task.EstimatedMinutes;
        _editTaskDueDate = task.DueDate;
        _editTaskStatus = task.Status;
        _editTaskEnergyLevel = task.EnergyLevel?.ToString() ?? string.Empty;
        _showEditTaskModal = true;
    }

    private async Task SaveEditTask()
    {
        if (_editingTask == null) return;

        _editingTask.Title = _editTaskTitle;
        _editingTask.Description = string.IsNullOrWhiteSpace(_editTaskDescription) ? null : _editTaskDescription;
        _editingTask.Priority = _editTaskPriority;
        _editingTask.EstimatedMinutes = _editTaskMinutes;
        _editingTask.DueDate = _editTaskDueDate;
        _editingTask.Status = _editTaskStatus;
        _editingTask.EnergyLevel = string.IsNullOrWhiteSpace(_editTaskEnergyLevel) ? null : int.Parse(_editTaskEnergyLevel);

        await TaskService.UpdateAsync(_editingTask);
        _showEditTaskModal = false;
        _editingTask = null;
        await LoadProject();
    }

    private async Task SetTaskStatus(TodoTask task, TodoTaskStatus status)
    {
        task.Status = status;
        if (status == TodoTaskStatus.WaitingFor)
        {
            task.WaitingForSince = DateTime.UtcNow;
        }
        await TaskService.UpdateAsync(task);
        await LoadProject();
    }

    private async Task UnlinkTaskFromProject(TodoTask task)
    {
        task.ProjectId = null;
        await TaskService.UpdateAsync(task);
        await LoadProject();
    }

    private void ShowDeleteTaskConfirm(TodoTask task)
    {
        _taskToDelete = task;
        _showDeleteTaskConfirm = true;
    }

    private async Task ConfirmDeleteTask()
    {
        if (_taskToDelete != null)
        {
            await TaskService.DeleteAsync(_taskToDelete.Id);
            _showDeleteTaskConfirm = false;
            _taskToDelete = null;
            await LoadProject();
        }
    }
}
